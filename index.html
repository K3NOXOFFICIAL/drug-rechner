<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K3NOX Drug Calc - Drug Calculator Suite</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Comprehensive drug calculator suite for harm reduction education and scientific research. Calculate dosages for MDMA, LSD, Ketamine, GHB, and more with advanced tolerance modeling and safety features.">
    <meta name="keywords" content="drug calculator, harm reduction, dosage calculator, tolerance calculator, MDMA calculator, LSD calculator, ketamine calculator, substance safety, pharmacology">
    <meta name="author" content="K3NOX Drug Calc">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://k3noxofficial.github.io/drug-rechner/">
    <meta property="og:title" content="K3NOX Drug Calc - Drug Calculator Suite">
    <meta property="og:description" content="🧮 Comprehensive drug calculator suite for harm reduction education and scientific research. Features advanced tolerance modeling, safety warnings, and interactive graphs for 8+ substances.">
    <meta property="og:image" content="https://k3noxofficial.github.io/drug-rechner/preview-image.svg">
    <meta property="og:image:type" content="image/svg+xml">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="K3NOX Drug Calc - Harm Reduction Calculator Suite with dose calculator, tolerance calculator, and liquid dosage tools">
    <meta property="og:site_name" content="K3NOX Drug Calc">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter Card -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://k3noxofficial.github.io/drug-rechner/">
    <meta property="twitter:title" content="K3NOX Drug Calc - Drug Calculator Suite">
    <meta property="twitter:description" content="🧮 Comprehensive drug calculator suite for harm reduction education and scientific research. Features advanced tolerance modeling, safety warnings, and interactive graphs for 8+ substances.">
    <meta property="twitter:image" content="https://k3noxofficial.github.io/drug-rechner/preview-image.svg">
    <meta property="twitter:image:alt" content="K3NOX Drug Calc - Drug Calculator Suite Interface">
    
    <!-- Telegram specific optimizations -->
    <meta property="telegram:channel" content="@k3noxofficial">
    <meta property="telegram:image" content="https://k3noxofficial.github.io/drug-rechner/preview-image.svg">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Additional Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="K3NOX Drug Calc">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🧮</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🧮</text></svg>">
    
    <!-- Schema.org markup for better SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "K3NOX Drug Calc - Drug Calculator Suite",
        "description": "Comprehensive drug calculator suite for harm reduction education and scientific research with advanced tolerance modeling and safety features.",
        "url": "https://k3noxofficial.github.io/drug-rechner/",
        "applicationCategory": "HealthApplication",
        "operatingSystem": "Any",
        "permissions": "none",
        "isAccessibleForFree": true,
        "creator": {
            "@type": "Organization",
            "name": "K3NOX Drug Calc"
        },
        "audience": {
            "@type": "Audience",
            "audienceType": "Researchers, Harm Reduction Educators"
        },
        "mainEntity": {
            "@type": "Thing",
            "name": "Drug Dosage Calculator",
            "description": "Educational calculator for substance dosage and tolerance modeling"
        }
    }
    </script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --secondary-color: #6b7280;
            --accent-color: #06b6d4;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --background-primary: #000000;
            --background-secondary: #111111;
            --background-card: #1a1a1a;
            --background-elevated: #222222;
            --text-primary: #ffffff;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #333333;
            --border-light: #2a2a2a;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.5), 0 4px 6px -4px rgb(0 0 0 / 0.4);
            --radius-sm: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--background-primary);
            min-height: 100vh;
            font-size: 16px;
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        /* Header Styling */
        .header {
            padding: 4rem 0 3rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .header-content {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .brand {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .brand-icon {
            font-size: 3.5rem;
            opacity: 0.9;
        }
        
        .brand-text h1 {
            font-size: 3rem;
            font-weight: 600;
            margin: 0;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }
        
        .brand-tagline {
            font-size: 0.875rem;
            font-weight: 400;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-top: 0.5rem;
            display: block;
        }
        
        .header-description {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 400;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 3rem 0;
            padding: 0;
        }
        
        .tab-btn {
            background: var(--background-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        
        .tab-btn:hover {
            background: var(--background-elevated);
            color: var(--text-primary);
            border-color: var(--primary-color);
        }
        
        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* Dropdown Styling */
        .dose-calculators {
            position: relative;
            display: inline-block;
        }
        
        .dose-toggle {
            background: var(--background-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .dose-toggle:hover {
            background: var(--background-elevated);
            color: var(--text-primary);
            border-color: var(--primary-color);
        }
        
        .dose-toggle.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .dose-menu {
            display: none;
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 50%;
            transform: translateX(-50%);
            background: var(--background-card);
            min-width: 320px;
            max-width: 400px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            z-index: 1000;
            animation: slideDown 0.2s ease;
        }
        
        .dose-menu.show {
            display: block;
        }
        
        .dose-category {
            margin-bottom: 0.75rem;
        }
        
        .dose-category:last-child {
            margin-bottom: 0;
        }
        
        .dose-category-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.5rem 0.75rem 0.25rem;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 0.25rem;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .dose-menu-item {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            text-align: left;
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .dose-menu-item:hover {
            background: var(--background-elevated);
            color: var(--text-primary);
        }
        
        .dose-menu-item.active {
            background: var(--primary-color);
            color: white;
        }
        
        .dropdown-arrow {
            transition: transform 0.2s ease;
            font-size: 0.75rem;
        }
        
        .dose-calculators.open .dropdown-arrow {
            transform: rotate(180deg);
        }
        
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .mobile-overlay.show {
            display: block;
        }
        
        /* Calculator Sections */
        .calculator-section {
            display: none;
            background: var(--background-card);
            border-radius: var(--radius-xl);
            padding: 3rem;
            margin-bottom: 3rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: fadeIn 0.3s ease;
        }
        
        .calculator-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .calculator-section h2 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }
        
        .calculator-section p {
            color: var(--text-secondary);
            margin-bottom: 2.5rem;
            font-size: 1rem;
        }
        
        /* Form Styling */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 2.5rem;
        }
        
        .input-group {
            background: var(--background-secondary);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .input-group:hover {
            border-color: var(--primary-color);
        }
        
        .input-group:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .input-group label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background: var(--background-primary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .input-group input::placeholder {
            color: var(--text-muted);
        }
        
        /* Button Styling */
        .btn {
            background: var(--primary-color);
            color: white;
            padding: 1.25rem 2.5rem;
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: block;
            margin: 2rem auto;
            min-width: 220px;
            box-shadow: var(--shadow-sm);
        }
        
        .btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        /* Result Styling */
        .result {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: var(--shadow-sm);
        }
        
        .result h3 {
            color: var(--success-color);
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .result-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--success-color);
            text-align: center;
            margin: 1.5rem 0;
        }
        
        /* Warning Styling */
        .warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: var(--shadow-sm);
        }
        
        .warning.danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .warning h4 {
            color: var(--warning-color);
            margin-bottom: 1rem;
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .warning.danger h4 {
            color: var(--danger-color);
        }
        
        /* Disclaimer */
        .disclaimer {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-xl);
            padding: 2rem;
            margin: 2rem 0 3rem 0;
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }
        
        .disclaimer h4 {
            color: var(--danger-color);
            margin-bottom: 1rem;
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .disclaimer h4::before {
            content: "⚠️";
            font-size: 1.25rem;
        }
        
        .disclaimer p {
            margin: 0;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        
        /* Scientific Note */
        .scientific-note {
            background: var(--background-secondary);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-top: 1.5rem;
            font-style: italic;
            color: var(--text-secondary);
            border-left: 4px solid var(--secondary-color);
            font-size: 0.875rem;
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted var(--text-muted);
        }
        
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--background-elevated);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 1000;
            pointer-events: none;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }
        
        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }
        
        /* Graph Container */
        .graph-container {
            background: var(--background-secondary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin: 2rem 0;
            border: 1px solid var(--border-color);
        }
        
        .graph-wrapper {
            display: flex;
            justify-content: center;
            background: var(--background-card);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }
        
        #tolerance-graph {
            max-width: 100%;
            height: auto;
            border-radius: var(--radius-sm);
        }
        
        .graph-legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-primary);
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: var(--radius-sm);
            display: inline-block;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 0.75rem;
            }
            
            .header {
                padding: 2rem 0 1.5rem;
            }
            
            .brand {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .brand-text h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 0.75rem;
                padding: 1.5rem;
            }
            
            .tab-btn,
            .dose-toggle {
                width: 100%;
                justify-content: center;
            }
            
            .dose-calculators {
                width: 100%;
            }
            
            .dose-menu {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 320px;
                max-height: 60vh;
                overflow-y: auto;
                border-radius: var(--radius-xl);
                padding: 1rem;
            }
            
            .calculator-section {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .calculator-section h2 {
                font-size: 1.5rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .input-group {
                padding: 1rem;
            }
            
            .result-value {
                font-size: 1.5rem;
            }
            
            .footer-content {
                grid-template-columns: 1fr;
                gap: 2rem;
                text-align: center;
            }
            
            .modal-content {
                width: 95%;
                margin: 1rem auto;
                max-height: 90vh;
            }
        }
        
        @media (max-width: 480px) {
            .brand-icon {
                font-size: 2.5rem;
            }
            
            .brand-text h1 {
                font-size: 1.75rem;
            }
            
            .header-description {
                font-size: 1rem;
            }
            
            .calculator-section {
                padding: 1rem;
            }
            
            .disclaimer {
                padding: 1.5rem;
            }
        }
        
        /* Footer Styling */
        .footer {
            background: var(--background-secondary);
            border-top: 1px solid var(--border-color);
            padding: 3rem 0 2rem;
            margin-top: 4rem;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 3rem;
            margin-bottom: 2rem;
        }
        
        .footer-section h4 {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .footer-section p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .footer-links {
            list-style: none;
            padding: 0;
        }
        
        .footer-links li {
            margin-bottom: 0.5rem;
        }
        
        .footer-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.2s ease;
        }
        
        .footer-links a:hover {
            color: var(--primary-color);
        }
        
        .footer-bottom {
            border-top: 1px solid var(--border-color);
            padding-top: 2rem;
            text-align: center;
        }
        
        .footer-bottom p {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        .footer-disclaimer {
            font-size: 0.75rem !important;
            font-style: italic;
        }
        
        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background-color: var(--background-card);
            margin: 2rem auto;
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease;
            overflow: hidden;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--background-secondary);
        }
        
        .modal-header h2 {
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }
        
        .close {
            color: var(--text-muted);
            font-size: 2rem;
            font-weight: 300;
            cursor: pointer;
            transition: color 0.2s ease;
            line-height: 1;
        }
        
        .close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            max-height: 70vh;
        }
        
        .legal-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .legal-content section {
            margin-bottom: 2rem;
        }
        
        .legal-content h3 {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        
        .legal-content p {
            margin-bottom: 1rem;
        }
        
        .legal-content ul {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }
        
        .legal-content li {
            margin-bottom: 0.5rem;
        }
        
        .legal-content strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .legal-update {
            font-style: italic;
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="brand">
                    <div class="brand-icon">🧮</div>
                    <div class="brand-text">
                        <h1>K3NOX Drug Calc</h1>
                        <span class="brand-tagline">Harm Reduction Calculator Suite</span>
                    </div>
                </div>
                <p class="header-description">Evidence-based dosage calculations for educational and research purposes</p>
            </div>
        </div>

        <div class="disclaimer">
            <h4>For Scientific/Educational Purposes Only</h4>
            <p>This calculator is designed for harm reduction education and scientific research purposes. Always consult medical professionals and follow local laws. Individual responses vary significantly, and these calculations are theoretical models based on general guidelines.</p>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showCalculator('liquid')">💧 Liquid Dosage</button>
            
            <div class="dose-calculators">
                <button class="dose-toggle" id="dose-calc-btn" onclick="toggleDoseMenu()">
                    💊 Dose Calculator 
                    <span class="dropdown-arrow">▼</span>
                </button>
                <div class="dose-menu" id="dose-menu">
                    <div class="dose-category">
                        <div class="dose-category-title">💊 Entactogens/Empathogens</div>
                        <button class="dose-menu-item" onclick="selectDoseCalculator('mdma')">💊 MDMA (Ecstasy/Molly)</button>
                        <button class="dose-menu-item" onclick="selectDoseCalculator('4mmc')">🔥 4-MMC (Mephedrone)</button>
                    </div>
                    <div class="dose-category">
                        <div class="dose-category-title">🌈 Psychedelics</div>
                        <button class="dose-menu-item" onclick="selectDoseCalculator('lsd')">🌈 LSD (Acid)</button>
                    </div>
                    <div class="dose-category">
                        <div class="dose-category-title">🧠 Dissociatives</div>
                        <button class="dose-menu-item" onclick="selectDoseCalculator('ketamine')">� Ketamine (Special K)</button>
                    </div>
                    <div class="dose-category">
                        <div class="dose-category-title">⚡ Stimulants</div>
                        <button class="dose-menu-item" onclick="selectDoseCalculator('amphetamines')">⚡ Amphetamines (Speed)</button>
                        <button class="dose-menu-item" onclick="selectDoseCalculator('cocaine')">❄️ Cocaine</button>
                    </div>
                    <div class="dose-category">
                        <div class="dose-category-title">🥤 Depressants</div>
                        <button class="dose-menu-item" onclick="selectDoseCalculator('ghb')">🥤 GHB/GBL</button>
                    </div>
                </div>
            </div>
            
            <button class="tab-btn" onclick="showCalculator('tolerance')">⚖️ Tolerance Calculator</button>
        </div>

        <!-- Mobile overlay -->
        <div class="mobile-overlay" id="mobile-overlay" onclick="closeDoseMenu()"></div>

        <!-- Liquid Dosage Calculator -->
        <div id="liquid" class="calculator-section active">
            <h2>� Liquid Dosage Calculator</h2>
            <p>Calculate the amount of medication in a specific volume of liquid</p>

            <div class="form-grid">
                <div class="input-group">
                    <label for="total-volume">Total liquid volume (ml):</label>
                    <input type="number" id="total-volume" placeholder="e.g., 28" step="0.1">
                </div>

                <div class="input-group">
                    <label for="total-medication">Total medication (g):</label>
                    <input type="number" id="total-medication" placeholder="e.g., 4" step="0.01">
                </div>

                <div class="input-group">
                    <label for="drug-purity" class="tooltip" data-tooltip="Purity percentage of the substance">Drug Purity (%):</label>
                    <input type="number" id="drug-purity" value="100" placeholder="e.g., 97" min="0" max="100">
                </div>

                <div class="input-group">
                    <label for="target-volume">Target volume (ml):</label>
                    <input type="number" id="target-volume" value="0.1" placeholder="e.g., 0.1" step="0.01">
                </div>
            </div>

            <button class="btn" onclick="calculateLiquidDose()">Calculate Liquid Dose</button>

            <div id="liquid-result" class="result" style="display: none;">
                <h3>Result:</h3>
                <div class="result-value" id="liquid-result-value"></div>
            </div>
        </div>

        <!-- MDMA Calculator -->
        <div id="mdma" class="calculator-section">
            <h2>💊 MDMA Dose Calculator</h2>
            <p>Calculate MDMA dosage based on body weight, experience, and individual factors with enhanced safety considerations</p>

            <div class="form-grid">
                <div class="input-group">
                    <label for="mdma-weight">Body Weight (kg):</label>
                    <input type="number" id="mdma-weight" placeholder="e.g., 70" min="40" max="150">
                </div>

                <div class="input-group">
                    <label for="mdma-gender">Gender:</label>
                    <select id="mdma-gender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other/Prefer not to say</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="mdma-experience" class="tooltip" data-tooltip="Your experience level with MDMA affects recommended dosage">Experience Level:</label>
                    <select id="mdma-experience">
                        <option value="">Select Experience</option>
                        <option value="beginner">Beginner (0-2 times)</option>
                        <option value="experienced">Experienced (3-10 times)</option>
                        <option value="expert">Expert (10+ times)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="mdma-intensity">Desired Intensity:</label>
                    <select id="mdma-intensity">
                        <option value="">Select Intensity</option>
                        <option value="threshold">Threshold (mild effects)</option>
                        <option value="light">Light (noticeable effects)</option>
                        <option value="common">Common (full experience)</option>
                        <option value="strong">Strong (intense experience)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="mdma-last-use" class="tooltip" data-tooltip="Time since last MDMA use affects tolerance and safety">Days since last MDMA use:</label>
                    <input type="number" id="mdma-last-use" placeholder="e.g., 90" min="0" value="90">
                </div>

                <div class="input-group">
                    <label for="mdma-setting">Setting/Environment:</label>
                    <select id="mdma-setting">
                        <option value="">Select Setting</option>
                        <option value="home">Home/Private setting</option>
                        <option value="club">Club/Rave</option>
                        <option value="festival">Festival/Outdoor</option>
                        <option value="therapy">Therapeutic setting</option>
                    </select>
                </div>
            </div>

            <button class="btn" onclick="calculateMDMA()">Calculate MDMA Dose</button>

            <div id="mdma-result" class="result" style="display: none;">
                <h3>Recommended MDMA Dose:</h3>
                <div class="result-value" id="mdma-result-value"></div>
                <div id="mdma-details"></div>
            </div>
        </div>

        <!-- Enhanced LSD Calculator -->
        <div id="lsd" class="calculator-section">
            <h2>🌈 LSD Dose Calculator</h2>
            <p>Calculate LSD dosage with enhanced safety considerations and detailed experience information</p>

            <div class="form-grid">
                <div class="input-group">
                    <label for="lsd-weight">Body Weight (kg):</label>
                    <input type="number" id="lsd-weight" placeholder="e.g., 70" min="40" max="150">
                </div>

                <div class="input-group">
                    <label for="lsd-gender">Gender:</label>
                    <select id="lsd-gender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other/Prefer not to say</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="lsd-experience">Psychedelic Experience:</label>
                    <select id="lsd-experience">
                        <option value="">Select Experience</option>
                        <option value="beginner">Beginner (0-2 psychedelic experiences)</option>
                        <option value="experienced">Experienced (3-15 experiences)</option>
                        <option value="expert">Expert (15+ experiences)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="lsd-intensity">Desired Intensity:</label>
                    <select id="lsd-intensity">
                        <option value="">Select Intensity</option>
                        <option value="microdose">Microdose (sub-perceptual)</option>
                        <option value="threshold">Threshold (barely perceptible)</option>
                        <option value="light">Light (clear effects)</option>
                        <option value="common">Common (full experience)</option>
                        <option value="strong">Strong (intense experience)</option>
                        <option value="heavy">Heavy (overwhelming intensity)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="lsd-last-psychedelic" class="tooltip" data-tooltip="Time since last psychedelic use affects tolerance">Days since last psychedelic:</label>
                    <input type="number" id="lsd-last-psychedelic" placeholder="e.g., 14" min="0" value="14">
                </div>

                <div class="input-group">
                    <label for="lsd-setting">Setting/Environment:</label>
                    <select id="lsd-setting">
                        <option value="">Select Setting</option>
                        <option value="home">Home/Safe indoor space</option>
                        <option value="nature">Nature/Outdoor setting</option>
                        <option value="controlled">Controlled/Therapeutic setting</option>
                        <option value="festival">Festival/Social gathering</option>
                    </select>
                </div>
            </div>

            <button class="btn" onclick="calculateLSD()">Calculate LSD Dose</button>

            <div id="lsd-result" class="result" style="display: none;">
                <h3>Recommended LSD Dose:</h3>
                <div class="result-value" id="lsd-result-value"></div>
                <div id="lsd-details"></div>
            </div>
        </div>

        <!-- Ketamine Calculator (Enhanced) -->
        <div id="ketamine" class="calculator-section">
            <h2>🧠 Ketamine Dose Calculator</h2>
            <p>Calculate ketamine dosage with comprehensive safety considerations and tolerance modeling</p>

            <div class="form-grid">
                <div class="input-group">
                    <label for="ket-weight">Body Weight (kg):</label>
                    <input type="number" id="ket-weight" placeholder="e.g., 70" min="40" max="150">
                </div>

                <div class="input-group">
                    <label for="ket-gender">Gender:</label>
                    <select id="ket-gender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other/Prefer not to say</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="ket-experience" class="tooltip" data-tooltip="Your experience level with dissociatives affects recommended dosage">Experience Level:</label>
                    <select id="ket-experience">
                        <option value="">Select Experience</option>
                        <option value="beginner">Beginner (0-3 times)</option>
                        <option value="experienced">Experienced (4-15 times)</option>
                        <option value="expert">Expert (15+ times)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="ket-route">Route of Administration:</label>
                    <select id="ket-route">
                        <option value="">Select Route</option>
                        <option value="oral">Oral</option>
                        <option value="nasal">Nasal (insufflated)</option>
                        <option value="sublingual">Sublingual</option>
                        <option value="intramuscular">Intramuscular (IM)</option>
                        <option value="intravenous">Intravenous (IV)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="ket-intensity">Desired Intensity:</label>
                    <select id="ket-intensity">
                        <option value="">Select Intensity</option>
                        <option value="threshold">Threshold (mild dissociation)</option>
                        <option value="light">Light (noticeable effects)</option>
                        <option value="common">Common (full dissociative experience)</option>
                        <option value="strong">Strong (intense dissociation)</option>
                        <option value="k-hole">K-hole (complete dissociation)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="ket-last-use" class="tooltip" data-tooltip="Time since last ketamine/dissociative use affects tolerance">Days since last ketamine use:</label>
                    <input type="number" id="ket-last-use" placeholder="e.g., 7" min="0" value="7">
                </div>

                <div class="input-group">
                    <label for="ket-setting">Setting/Environment:</label>
                    <select id="ket-setting">
                        <option value="">Select Setting</option>
                        <option value="home">Home/Safe indoor space</option>
                        <option value="therapeutic">Therapeutic/Medical setting</option>
                        <option value="party">Party/Social gathering</option>
                        <option value="club">Club/Rave</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="ket-tolerance-history" class="tooltip" data-tooltip="How frequently have you used ketamine in the past 3 months?">Recent Usage Pattern:</label>
                    <select id="ket-tolerance-history">
                        <option value="">Select Pattern</option>
                        <option value="none">No recent use (3+ months)</option>
                        <option value="occasional">Occasional (1-3 times)</option>
                        <option value="regular">Regular (4-10 times)</option>
                        <option value="frequent">Frequent (10+ times)</option>
                    </select>
                </div>
            </div>

            <button class="btn" onclick="calculateKetamine()">Calculate Ketamine Dose</button>

            <div id="ketamine-result" class="result" style="display: none;">
                <h3>Recommended Ketamine Dose:</h3>
                <div class="result-value" id="ket-result-value"></div>
                <div id="ket-details"></div>
                <div class="scientific-note">
                    Based on ketamine's tolerance half-life of approximately 3-5 days and NMDA receptor downregulation patterns.
                </div>
            </div>
        </div>

        <!-- GHB/GBL Calculator -->
        <div id="ghb" class="calculator-section">
            <h2>🥤 GHB/GBL Dose Calculator</h2>
            <p>Calculate GHB or GBL dosage with comprehensive safety considerations and harm reduction factors</p>

            <div class="form-grid">
                <div class="input-group">
                    <label for="ghb-weight">Body Weight (kg):</label>
                    <input type="number" id="ghb-weight" placeholder="e.g., 70" min="40" max="150">
                </div>

                <div class="input-group">
                    <label for="ghb-gender">Gender:</label>
                    <select id="ghb-gender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other/Prefer not to say</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="ghb-substance">Substance:</label>
                    <select id="ghb-substance">
                        <option value="">Select Substance</option>
                        <option value="ghb">GHB (Sodium γ-hydroxybutyrate)</option>
                        <option value="gbl">GBL (γ-butyrolactone)</option>
                        <option value="bdo">1,4-BDO (1,4-butanediol)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="ghb-experience" class="tooltip" data-tooltip="Your experience level with GHB/depressants affects safety considerations">Experience Level:</label>
                    <select id="ghb-experience">
                        <option value="">Select Experience</option>
                        <option value="beginner">Beginner (0-2 times)</option>
                        <option value="experienced">Experienced (3-10 times)</option>
                        <option value="expert">Expert (10+ times)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="ghb-intensity">Desired Intensity:</label>
                    <select id="ghb-intensity">
                        <option value="">Select Intensity</option>
                        <option value="threshold">Threshold (mild relaxation)</option>
                        <option value="light">Light (noticeable effects)</option>
                        <option value="common">Common (full euphoric effects)</option>
                        <option value="strong">Strong (intense sedation)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="ghb-last-use" class="tooltip" data-tooltip="Time since last GHB/depressant use affects tolerance">Days since last GHB use:</label>
                    <input type="number" id="ghb-last-use" placeholder="e.g., 3" min="0" value="3">
                </div>

                <div class="input-group">
                    <label for="ghb-stomach" class="tooltip" data-tooltip="Food in stomach significantly affects absorption and safety">Stomach Status:</label>
                    <select id="ghb-stomach">
                        <option value="">Select Status</option>
                        <option value="empty">Empty stomach (4+ hours since food)</option>
                        <option value="light">Light food (2-3 hours ago)</option>
                        <option value="full">Full stomach (recent meal)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="ghb-setting">Setting/Environment:</label>
                    <select id="ghb-setting">
                        <option value="">Select Setting</option>
                        <option value="home">Home/Safe indoor space</option>
                        <option value="party">House party/Small gathering</option>
                        <option value="club">Club/Rave</option>
                        <option value="therapeutic">Therapeutic/Medical setting</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="ghb-alcohol" class="tooltip" data-tooltip="ANY alcohol consumption with GHB is extremely dangerous">Alcohol Consumption:</label>
                    <select id="ghb-alcohol">
                        <option value="">Select Status</option>
                        <option value="none">No alcohol (past 12+ hours)</option>
                        <option value="recent">Recent alcohol (within 12 hours)</option>
                        <option value="current">Currently under alcohol influence</option>
                    </select>
                </div>
            </div>

            <button class="btn" onclick="calculateGHB()">Calculate GHB/GBL Dose</button>

            <div id="ghb-result" class="result" style="display: none;">
                <h3>Recommended Dose:</h3>
                <div class="result-value" id="ghb-result-value"></div>
                <div id="ghb-details"></div>
            </div>
        </div>

        <!-- Amphetamines Calculator -->
        <div id="amphetamines" class="calculator-section">
            <h2>⚡ Amphetamines Dose Calculator</h2>
            <p>Calculate amphetamine dosage with comprehensive safety considerations and tolerance modeling</p>

            <div class="form-grid">
                <div class="input-group">
                    <label for="amp-weight">Body Weight (kg):</label>
                    <input type="number" id="amp-weight" placeholder="e.g., 70" min="40" max="150">
                </div>

                <div class="input-group">
                    <label for="amp-gender">Gender:</label>
                    <select id="amp-gender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other/Prefer not to say</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="amp-substance">Substance Type:</label>
                    <select id="amp-substance">
                        <option value="">Select Substance</option>
                        <option value="amphetamine">Amphetamine (racemic)</option>
                        <option value="dextroamphetamine">Dextroamphetamine</option>
                        <option value="methamphetamine">Methamphetamine</option>
                        <option value="adderall">Adderall (mixed salts)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="amp-experience" class="tooltip" data-tooltip="Your experience level with stimulants affects safety considerations">Experience Level:</label>
                    <select id="amp-experience">
                        <option value="">Select Experience</option>
                        <option value="beginner">Beginner (0-3 times)</option>
                        <option value="experienced">Experienced (4-20 times)</option>
                        <option value="expert">Expert (20+ times)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="amp-route">Route of Administration:</label>
                    <select id="amp-route">
                        <option value="">Select Route</option>
                        <option value="oral">Oral (swallowed)</option>
                        <option value="nasal">Nasal (insufflated)</option>
                        <option value="sublingual">Sublingual (under tongue)</option>
                        <option value="rectal">Rectal (plugged)</option>
                        <option value="intravenous">Intravenous (IV)</option>
                        <option value="smoked">Smoked/Vaporized</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="amp-intensity">Desired Intensity:</label>
                    <select id="amp-intensity">
                        <option value="">Select Intensity</option>
                        <option value="threshold">Threshold (mild stimulation)</option>
                        <option value="light">Light (clear effects)</option>
                        <option value="common">Common (full stimulation)</option>
                        <option value="strong">Strong (intense effects)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="amp-last-use" class="tooltip" data-tooltip="Time since last stimulant use affects tolerance">Days since last stimulant use:</label>
                    <input type="number" id="amp-last-use" placeholder="e.g., 7" min="0" value="7">
                </div>

                <div class="input-group">
                    <label for="amp-setting">Setting/Environment:</label>
                    <select id="amp-setting">
                        <option value="">Select Setting</option>
                        <option value="home">Home/Study environment</option>
                        <option value="work">Work/Productivity setting</option>
                        <option value="party">Party/Social gathering</option>
                        <option value="club">Club/Rave</option>
                        <option value="therapeutic">Therapeutic/Medical setting</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="amp-health" class="tooltip" data-tooltip="Cardiovascular conditions significantly affect stimulant safety">Cardiovascular Health:</label>
                    <select id="amp-health">
                        <option value="">Select Status</option>
                        <option value="healthy">Healthy (no known issues)</option>
                        <option value="minor">Minor issues (controlled)</option>
                        <option value="moderate">Moderate cardiovascular concerns</option>
                        <option value="serious">Serious heart/blood pressure issues</option>
                    </select>
                </div>
            </div>

            <button class="btn" onclick="calculateAmphetamines()">Calculate Amphetamine Dose</button>

            <div id="amp-result" class="result" style="display: none;">
                <h3>Recommended Dose:</h3>
                <div class="result-value" id="amp-result-value"></div>
                <div id="amp-details"></div>
            </div>
        </div>

        <!-- Cocaine Calculator -->
        <div id="cocaine" class="calculator-section">
            <h2>❄️ Cocaine Dose Calculator</h2>
            <p>Calculate cocaine dosage with comprehensive safety considerations and harm reduction factors</p>

            <div class="form-grid">
                <div class="input-group">
                    <label for="coc-weight">Body Weight (kg):</label>
                    <input type="number" id="coc-weight" placeholder="e.g., 70" min="40" max="150">
                </div>

                <div class="input-group">
                    <label for="coc-gender">Gender:</label>
                    <select id="coc-gender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other/Prefer not to say</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="coc-experience" class="tooltip" data-tooltip="Your experience level with stimulants affects safety considerations">Experience Level:</label>
                    <select id="coc-experience">
                        <option value="">Select Experience</option>
                        <option value="beginner">Beginner (0-3 times)</option>
                        <option value="experienced">Experienced (4-15 times)</option>
                        <option value="expert">Expert (15+ times)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="coc-route">Route of Administration:</label>
                    <select id="coc-route">
                        <option value="">Select Route</option>
                        <option value="nasal">Nasal (insufflated)</option>
                        <option value="oral">Oral (swallowed)</option>
                        <option value="gums">Gums (rubbed on gums)</option>
                        <option value="smoked">Smoked (crack/freebase)</option>
                        <option value="intravenous">Intravenous (IV)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="coc-intensity">Desired Intensity:</label>
                    <select id="coc-intensity">
                        <option value="">Select Intensity</option>
                        <option value="threshold">Threshold (mild stimulation)</option>
                        <option value="light">Light (clear effects)</option>
                        <option value="common">Common (full stimulation)</option>
                        <option value="strong">Strong (intense effects)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="coc-last-use" class="tooltip" data-tooltip="Time since last stimulant use affects tolerance">Days since last cocaine use:</label>
                    <input type="number" id="coc-last-use" placeholder="e.g., 14" min="0" value="14">
                </div>

                <div class="input-group">
                    <label for="coc-setting">Setting/Environment:</label>
                    <select id="coc-setting">
                        <option value="">Select Setting</option>
                        <option value="home">Home/Private setting</option>
                        <option value="party">Party/Social gathering</option>
                        <option value="club">Club/Nightlife</option>
                        <option value="public">Public/Outdoor setting</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="coc-health" class="tooltip" data-tooltip="Cardiovascular health is critical with cocaine use">Cardiovascular Health:</label>
                    <select id="coc-health">
                        <option value="">Select Status</option>
                        <option value="healthy">Healthy (no known issues)</option>
                        <option value="minor">Minor issues (controlled)</option>
                        <option value="moderate">Moderate cardiovascular concerns</option>
                        <option value="serious">Serious heart/blood pressure issues</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="coc-alcohol" class="tooltip" data-tooltip="Alcohol and cocaine create dangerous cocaethylene">Alcohol Consumption:</label>
                    <select id="coc-alcohol">
                        <option value="">Select Status</option>
                        <option value="none">No alcohol (past 12+ hours)</option>
                        <option value="recent">Recent alcohol (within 12 hours)</option>
                        <option value="current">Currently under alcohol influence</option>
                    </select>
                </div>
            </div>

            <button class="btn" onclick="calculateCocaine()">Calculate Cocaine Dose</button>

            <div id="coc-result" class="result" style="display: none;">
                <h3>Recommended Dose:</h3>
                <div class="result-value" id="coc-result-value"></div>
                <div id="coc-details"></div>
            </div>
        </div>

        <!-- 4-MMC Calculator (Enhanced) -->
        <div id="4mmc" class="calculator-section">
            <h2>🔥 4-MMC (Mephedrone) Calculator</h2>
            <p>Calculate safe 4-MMC dosage with comprehensive harm reduction factors</p>

            <div class="form-grid">
                <div class="input-group">
                    <label for="mmc-weight">Body Weight (kg):</label>
                    <input type="number" id="mmc-weight" placeholder="e.g., 70" min="40" max="150">
                </div>

                <div class="input-group">
                    <label for="mmc-gender">Gender:</label>
                    <select id="mmc-gender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other/Non-binary</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="mmc-experience">Experience Level:</label>
                    <select id="mmc-experience">
                        <option value="">Select Experience</option>
                        <option value="beginner">Beginner (No/Limited experience)</option>
                        <option value="experienced">Experienced (Regular user)</option>
                        <option value="expert">Expert (Extensive experience)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="mmc-route">Route of Administration:</label>
                    <select id="mmc-route">
                        <option value="">Select Route</option>
                        <option value="oral">Oral (Capsule/Bomb)</option>
                        <option value="nasal">Nasal (Insufflation)</option>
                        <option value="rectal">Rectal (Plugging)</option>
                        <option value="intravenous">Intravenous (IV) - EXTREME RISK</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="mmc-intensity">Desired Intensity:</label>
                    <select id="mmc-intensity">
                        <option value="">Select Intensity</option>
                        <option value="threshold">Threshold (Just noticeable)</option>
                        <option value="light">Light (Mild effects)</option>
                        <option value="common">Common (Moderate effects)</option>
                        <option value="strong">Strong (Intense effects)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="mmc-last-use">Days Since Last 4-MMC Use:</label>
                    <input type="number" id="mmc-last-use" placeholder="e.g., 14" min="0" max="365">
                </div>

                <div class="input-group">
                    <label for="mmc-setting">Setting/Environment:</label>
                    <select id="mmc-setting">
                        <option value="">Select Setting</option>
                        <option value="home">Home (Safe, controlled)</option>
                        <option value="party">House Party (Social)</option>
                        <option value="club">Club/Rave (High stimulation)</option>
                        <option value="public">Public/Unknown (Higher risk)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="mmc-cardiovascular">Cardiovascular Health:</label>
                    <select id="mmc-cardiovascular">
                        <option value="">Select Health Status</option>
                        <option value="healthy">Healthy (No issues)</option>
                        <option value="minor">Minor concerns (Mild hypertension)</option>
                        <option value="moderate">Moderate issues (Heart conditions)</option>
                        <option value="serious">Serious conditions (Contraindicated)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="mmc-temperature">Temperature Management:</label>
                    <select id="mmc-temperature">
                        <option value="">Select Environment</option>
                        <option value="cool">Cool environment (Good ventilation)</option>
                        <option value="warm">Warm environment (Limited ventilation)</option>
                        <option value="hot">Hot environment (Poor ventilation/crowds)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="mmc-serotonin">Recent Serotonergic Drug Use:</label>
                    <select id="mmc-serotonin">
                        <option value="">Select Recent Use</option>
                        <option value="none">None in past 3 months</option>
                        <option value="mdma">MDMA/MDA within 3 months</option>
                        <option value="antidepressants">On antidepressants (SSRIs/SNRIs)</option>
                        <option value="recent">Other serotonergic drugs recently</option>
                    </select>
                </div>
            </div>

            <button class="btn" onclick="calculate4MMC()">Calculate 4-MMC Dose</button>

            <div id="mmc-result" class="result" style="display: none;">
                <h3>Recommended 4-MMC Dose:</h3>
                <div class="result-value" id="mmc-result-value"></div>
                <div id="mmc-details"></div>
            </div>
        </div>

        <!-- Tolerance Calculator -->
        <div id="tolerance" class="calculator-section">
            <h2>⚖️ Tolerance Calculator</h2>
            <p>Calculate how much you need to take for the same effect based on previous dose and time elapsed</p>

            <div class="form-grid">
                <div class="input-group">
                    <label for="tol-substance" class="tooltip" data-tooltip="Different substances have different tolerance patterns">Substance Type:</label>
                    <select id="tol-substance">
                        <option value="">Select Substance</option>
                        
                        <!-- Psychedelics -->
                        <option value="lsd">LSD (Lysergic Acid Diethylamide)</option>
                        <option value="psilocybin">Psilocybin (Magic Mushrooms)</option>
                        <option value="dmt">DMT (N,N-Dimethyltryptamine)</option>
                        <option value="2cb">2C-B</option>
                        <option value="mescaline">Mescaline</option>
                        
                        <!-- Entactogens -->
                        <option value="mdma">MDMA (Ecstasy/Molly)</option>
                        <option value="mda">MDA (Methylenedioxyamphetamine)</option>
                        <option value="4mmc">4-MMC (Mephedrone)</option>
                        <option value="6apb">6-APB</option>
                        
                        <!-- Stimulants -->
                        <option value="amphetamine">Amphetamine (Speed)</option>
                        <option value="dextroamphetamine">Dextroamphetamine (Dexedrine)</option>
                        <option value="methamphetamine">Methamphetamine (Crystal)</option>
                        <option value="cocaine">Cocaine</option>
                        <option value="caffeine">Caffeine</option>
                        <option value="modafinil">Modafinil</option>
                        
                        <!-- Dissociatives -->
                        <option value="ketamine">Ketamine</option>
                        <option value="dxm">DXM (Dextromethorphan)</option>
                        <option value="pcp">PCP</option>
                        <option value="3meopcp">3-MeO-PCP</option>
                        
                        <!-- Depressants -->
                        <option value="ghb">GHB (γ-Hydroxybutyric acid)</option>
                        <option value="gbl">GBL (γ-Butyrolactone)</option>
                        <option value="phenibut">Phenibut</option>
                        <option value="alcohol">Alcohol (Ethanol)</option>
                        <option value="xanax">Xanax (Alprazolam)</option>
                        <option value="valium">Valium (Diazepam)</option>
                        
                        <!-- Opioids -->
                        <option value="morphine">Morphine</option>
                        <option value="oxycodone">Oxycodone</option>
                        <option value="tramadol">Tramadol</option>
                        <option value="kratom">Kratom</option>
                        
                        <!-- Cannabis -->
                        <option value="thc">THC (Cannabis)</option>
                        <option value="cbd">CBD</option>
                        
                        <!-- Other -->
                        <option value="nitrous">Nitrous Oxide (N2O)</option>
                        <option value="custom">Custom (specify half-life)</option>
                    </select>
                </div>

                <div class="input-group" id="custom-halflife-group" style="display: none;">
                    <label for="tol-custom-halflife" class="tooltip" data-tooltip="Tolerance half-life in days - how long it takes for tolerance to reduce by 50%">Custom Tolerance Half-life (days):</label>
                    <input type="number" id="tol-custom-halflife" placeholder="e.g., 3" min="0.1" step="0.1">
                </div>

                <div class="input-group">
                    <label for="tol-previous-dose">Previous Dose:</label>
                    <input type="number" id="tol-previous-dose" placeholder="e.g., 100" step="0.1">
                </div>

                <div class="input-group">
                    <label for="tol-dose-unit">Dose Unit:</label>
                    <select id="tol-dose-unit">
                        <option value="mg">mg (milligrams)</option>
                        <option value="μg">μg (micrograms)</option>
                        <option value="g">g (grams)</option>
                        <option value="ml">ml (milliliters)</option>
                        <option value="tabs">tabs/hits</option>
                        <option value="custom">custom unit</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="tol-days-ago">Days Since Last Dose:</label>
                    <input type="number" id="tol-days-ago" placeholder="e.g., 4" min="0" step="0.1">
                </div>

                <div class="input-group">
                    <label for="tol-target-effect" class="tooltip" data-tooltip="What effect level are you aiming for?">Target Effect Level:</label>
                    <select id="tol-target-effect">
                        <option value="same">Same as previous dose</option>
                        <option value="stronger">Stronger than previous</option>
                        <option value="weaker">Weaker than previous</option>
                        <option value="baseline">Baseline (no tolerance)</option>
                    </select>
                </div>

                <div class="input-group" id="effect-multiplier-group" style="display: none;">
                    <label for="tol-effect-multiplier" class="tooltip" data-tooltip="How much stronger/weaker? 1.5 = 50% stronger, 0.7 = 30% weaker">Effect Multiplier:</label>
                    <input type="number" id="tol-effect-multiplier" placeholder="e.g., 1.5" min="0.1" max="3" step="0.1" value="1">
                </div>
            </div>

            <button class="btn" onclick="calculateGeneralTolerance()">Calculate Required Dose</button>

            <div id="tolerance-result" class="result" style="display: none;">
                <h3>Recommended Dose for Same Effect:</h3>
                <div class="result-value" id="tolerance-result-value"></div>
                <div id="tolerance-details"></div>
                
                <!-- Tolerance Recovery Graph -->
                <div class="graph-container" id="tolerance-graph-container" style="margin-top: 25px;">
                    <h4 style="text-align: center; color: #155724; margin-bottom: 15px;">📊 Tolerance Recovery Over Time</h4>
                    <div class="graph-wrapper">
                        <canvas id="tolerance-graph" width="600" height="300"></canvas>
                    </div>
                    <div class="graph-legend">
                        <div class="legend-item">
                            <span class="legend-color" style="background: #667eea;"></span>
                            <span>Tolerance Level (%)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #ff6b6b;"></span>
                            <span>Current Day</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>K3NOX Drug Calc</h4>
                    <p>Educational harm reduction calculator suite</p>
                </div>
                <div class="footer-section">
                    <h4>Legal</h4>
                    <ul class="footer-links">
                        <li><a href="#" onclick="openModal('tos')">Terms of Service</a></li>
                        <li><a href="#" onclick="openModal('privacy')">Privacy Policy</a></li>
                        <li><a href="#" onclick="openModal('usage')">Usage Agreement</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Information</h4>
                    <ul class="footer-links">
                        <li><a href="#" onclick="showCalculator('liquid')">Liquid Calculator</a></li>
                        <li><a href="#" onclick="showCalculator('tolerance')">Tolerance Calculator</a></li>
                        <li><a href="#" onclick="openDoseMenu()">Dose Calculators</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 K3NOX Drug Calc. For educational and harm reduction purposes only.</p>
                <p class="footer-disclaimer">This tool is not a substitute for medical advice. Always consult healthcare professionals.</p>
            </div>
        </div>
    </footer>

    <!-- Legal Document Modals -->
    <!-- Terms of Service Modal -->
    <div id="tos-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Terms of Service</h2>
                <span class="close" onclick="closeModal('tos')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="legal-content">
                    <section>
                        <h3>1. Acceptance of Terms</h3>
                        <p>By accessing and using K3NOX Drug Calc ("the Service"), you accept and agree to be bound by the terms and provision of this agreement. If you do not agree to abide by the above, please do not use this service.</p>
                    </section>
                    
                    <section>
                        <h3>2. Educational Purpose Only</h3>
                        <p>This calculator is designed exclusively for educational and harm reduction purposes. All calculations are theoretical and based on general guidelines found in scientific literature. Individual responses to substances vary significantly due to factors including but not limited to:</p>
                        <ul>
                            <li>Individual metabolism and body chemistry</li>
                            <li>Tolerance levels and previous use history</li>
                            <li>Mental and physical health conditions</li>
                            <li>Concurrent medications or substances</li>
                            <li>Set, setting, and environmental factors</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>3. Medical Disclaimer</h3>
                        <p>The information provided by this service is not medical advice and should not be used as a substitute for professional medical consultation, diagnosis, or treatment. Always seek the advice of your physician or other qualified health provider with any questions you may have regarding a medical condition or substance use.</p>
                    </section>
                    
                    <section>
                        <h3>4. Age Restrictions</h3>
                        <p>This service is intended for users who are 18 years of age or older. By using this service, you represent and warrant that you are at least 18 years old. If you are under 18, you must obtain parental or guardian consent before using this service.</p>
                    </section>
                    
                    <section>
                        <h3>5. Prohibited Uses</h3>
                        <p>You agree not to use this service:</p>
                        <ul>
                            <li>For any illegal purpose or to encourage illegal activities</li>
                            <li>To harm, abuse, harass, threaten, or intimidate others</li>
                            <li>To distribute malware or other malicious code</li>
                            <li>To make decisions regarding illegal substance use</li>
                            <li>In violation of any applicable laws or regulations</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>6. Limitation of Liability</h3>
                        <p>To the maximum extent permitted by applicable law, K3NOX Drug Calc and its operators shall not be liable for any indirect, incidental, special, consequential, or punitive damages, or any loss of profits or revenues, whether incurred directly or indirectly, or any loss of data, use, goodwill, or other intangible losses resulting from your use of the service.</p>
                    </section>
                    
                    <section>
                        <h3>7. Accuracy of Information</h3>
                        <p>While we strive to provide accurate information based on current scientific knowledge, we make no representations or warranties of any kind about the completeness, accuracy, reliability, suitability, or availability of the information, products, services, or related graphics contained in this service.</p>
                    </section>
                    
                    <section>
                        <h3>8. Changes to Terms</h3>
                        <p>We reserve the right to modify these terms at any time. Changes will be effective immediately upon posting to the service. Your continued use of the service after any such changes constitutes your acceptance of the new terms.</p>
                    </section>
                    
                    <section>
                        <h3>9. Governing Law</h3>
                        <p>These terms shall be governed by and construed in accordance with applicable international laws regarding educational content and harm reduction resources.</p>
                    </section>
                    
                    <p class="legal-update">Last updated: September 22, 2025</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacy-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Privacy Policy</h2>
                <span class="close" onclick="closeModal('privacy')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="legal-content">
                    <section>
                        <h3>1. Information We Collect</h3>
                        <p>K3NOX Drug Calc is designed with privacy in mind. We collect minimal information to provide our service:</p>
                        <ul>
                            <li><strong>No Personal Data:</strong> We do not collect, store, or process any personal information, names, email addresses, or identifying information.</li>
                            <li><strong>No Calculation History:</strong> All calculations are performed locally in your browser and are not stored or transmitted to our servers.</li>
                            <li><strong>Technical Data:</strong> We may collect basic technical information such as browser type, device type, and general geographic region (country level) for service improvement purposes.</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>2. How We Use Information</h3>
                        <p>Any technical information collected is used solely for:</p>
                        <ul>
                            <li>Improving service performance and compatibility</li>
                            <li>Understanding general usage patterns to enhance user experience</li>
                            <li>Ensuring service availability and security</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>3. Data Storage and Security</h3>
                        <p>Your privacy and security are paramount:</p>
                        <ul>
                            <li>All calculations are performed locally in your browser</li>
                            <li>No calculation data, inputs, or results are transmitted to our servers</li>
                            <li>No user accounts or profiles are created or maintained</li>
                            <li>No cookies are used for tracking or data collection</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>4. Third-Party Services</h3>
                        <p>This service operates independently and does not integrate with third-party analytics, advertising, or data collection services. We do not share any information with third parties.</p>
                    </section>
                    
                    <section>
                        <h3>5. Local Storage</h3>
                        <p>Your browser may store temporary data locally for functionality purposes. This data remains on your device and can be cleared by:</p>
                        <ul>
                            <li>Clearing your browser cache and cookies</li>
                            <li>Using private/incognito browsing mode</li>
                            <li>Manually clearing local storage in browser settings</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>6. Your Rights</h3>
                        <p>Since we do not collect personal data, traditional data protection rights do not apply. However, you maintain complete control over:</p>
                        <ul>
                            <li>All input data (entered only locally)</li>
                            <li>Calculation results (computed only locally)</li>
                            <li>Browser storage (can be cleared at any time)</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>7. Children's Privacy</h3>
                        <p>This service is not intended for children under 18. We do not knowingly collect any information from children. If you believe a child has accessed this service, please contact us immediately.</p>
                    </section>
                    
                    <section>
                        <h3>8. Changes to Privacy Policy</h3>
                        <p>We may update this privacy policy periodically. Any changes will be posted on this page with an updated revision date. Continued use of the service constitutes acceptance of any changes.</p>
                    </section>
                    
                    <section>
                        <h3>9. Contact Information</h3>
                        <p>If you have questions about this privacy policy or our data practices, please review our terms of service or contact us through official channels.</p>
                    </section>
                    
                    <p class="legal-update">Last updated: September 22, 2025</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Usage Agreement Modal -->
    <div id="usage-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Usage Agreement</h2>
                <span class="close" onclick="closeModal('usage')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="legal-content">
                    <section>
                        <h3>1. Harm Reduction Purpose</h3>
                        <p>K3NOX Drug Calc is a harm reduction educational tool designed to provide theoretical dosage calculations based on scientific literature. This tool is intended to:</p>
                        <ul>
                            <li>Educate users about dosage relationships and tolerance patterns</li>
                            <li>Provide general safety information about various substances</li>
                            <li>Support academic research and educational initiatives</li>
                            <li>Promote understanding of pharmacological principles</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>2. Educational Use Only</h3>
                        <p>This calculator is strictly for educational purposes and must not be used to:</p>
                        <ul>
                            <li>Make actual dosing decisions for any controlled or illegal substances</li>
                            <li>Replace professional medical advice or consultation</li>
                            <li>Plan or facilitate illegal drug use</li>
                            <li>Provide medical treatment recommendations</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>3. Safety Considerations</h3>
                        <p>Users must understand that:</p>
                        <ul>
                            <li>Individual responses to substances vary dramatically</li>
                            <li>Purity and composition of illegal substances cannot be guaranteed</li>
                            <li>Drug interactions can be dangerous and unpredictable</li>
                            <li>Mental health conditions may affect substance responses</li>
                            <li>No amount of any illegal substance can be considered "safe"</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>4. Medical Conditions</h3>
                        <p>This tool does not account for medical conditions that may affect substance metabolism or interactions, including but not limited to:</p>
                        <ul>
                            <li>Cardiovascular conditions</li>
                            <li>Liver or kidney dysfunction</li>
                            <li>Mental health disorders</li>
                            <li>Pregnancy or breastfeeding</li>
                            <li>Concurrent medications</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>5. Legal Considerations</h3>
                        <p>Users must be aware that:</p>
                        <ul>
                            <li>Controlled substances are illegal in most jurisdictions</li>
                            <li>Laws vary significantly by location</li>
                            <li>Possession, use, and distribution may carry serious legal penalties</li>
                            <li>This tool does not provide legal advice</li>
                            <li>Users are responsible for understanding and complying with local laws</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>6. Emergency Information</h3>
                        <p>In case of medical emergency or adverse reactions:</p>
                        <ul>
                            <li>Call emergency services immediately (911, 112, etc.)</li>
                            <li>Be honest with medical professionals about substance use</li>
                            <li>Do not delay seeking medical attention</li>
                            <li>Consider having naloxone (Narcan) available for opioid emergencies</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>7. Accuracy Limitations</h3>
                        <p>This tool's calculations are based on:</p>
                        <ul>
                            <li>General population averages and may not apply to individuals</li>
                            <li>Published research which may have limitations</li>
                            <li>Theoretical models that may not reflect real-world conditions</li>
                            <li>Assumptions about substance purity and consistency</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>8. Responsible Use Guidelines</h3>
                        <p>If using this tool for educational purposes, consider:</p>
                        <ul>
                            <li>Researching harm reduction strategies</li>
                            <li>Understanding drug testing and adulterant detection</li>
                            <li>Learning about safer use practices</li>
                            <li>Seeking support for substance use concerns</li>
                            <li>Consulting healthcare providers about substance use</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>9. Acknowledgment</h3>
                        <p>By using this service, you acknowledge that you have read, understood, and agree to comply with this usage agreement. You understand the educational nature of this tool and accept full responsibility for any decisions made based on the information provided.</p>
                    </section>
                    
                    <p class="legal-update">Last updated: September 22, 2025</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for dropdown state
        let isDoseMenuOpen = false;
        
        // Enhanced navigation functionality
        function showCalculator(calculatorId) {
            // Hide all calculators
            const sections = document.querySelectorAll('.calculator-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all main tabs
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from dose toggle
            const doseToggle = document.getElementById('dose-calc-btn');
            doseToggle.classList.remove('active');
            
            // Remove active class from all dose menu items
            const doseMenuItems = document.querySelectorAll('.dose-menu-item');
            doseMenuItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected calculator
            document.getElementById(calculatorId).classList.add('active');
            
            // Set active states based on calculator type
            const doseCalculators = ['mdma', 'lsd', 'ketamine', 'ghb', 'amphetamines', 'cocaine', '4mmc'];
            
            if (calculatorId === 'liquid') {
                // Activate liquid dosage tab
                document.querySelector('button[onclick="showCalculator(\'liquid\')"]').classList.add('active');
            } else if (calculatorId === 'tolerance') {
                // Activate general tolerance tab
                document.querySelector('button[onclick="showCalculator(\'tolerance\')"]').classList.add('active');
            } else if (doseCalculators.includes(calculatorId)) {
                // Activate dose calculator dropdown button
                doseToggle.classList.add('active');
                // Also activate the specific dropdown item
                const activeMenuItem = document.querySelector(`button[onclick="selectDoseCalculator('${calculatorId}')"]`);
                if (activeMenuItem) {
                    activeMenuItem.classList.add('active');
                }
            }
            
            // Close dose menu if open
            closeDoseMenu();
        }
        
        // Toggle dose calculator menu
        function toggleDoseMenu() {
            const doseMenu = document.getElementById('dose-menu');
            const mobileOverlay = document.getElementById('mobile-overlay');
            const doseCalculators = document.querySelector('.dose-calculators');
            
            if (isDoseMenuOpen) {
                closeDoseMenu();
            } else {
                openDoseMenu();
            }
        }
        
        // Open dose menu
        function openDoseMenu() {
            const doseMenu = document.getElementById('dose-menu');
            const mobileOverlay = document.getElementById('mobile-overlay');
            const doseCalculators = document.querySelector('.dose-calculators');
            
            doseMenu.classList.add('show');
            doseCalculators.classList.add('open');
            
            // Show overlay on mobile
            if (window.innerWidth <= 768) {
                mobileOverlay.classList.add('show');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }
            
            isDoseMenuOpen = true;
        }
        
        // Close dose menu
        function closeDoseMenu() {
            const doseMenu = document.getElementById('dose-menu');
            const mobileOverlay = document.getElementById('mobile-overlay');
            const doseCalculators = document.querySelector('.dose-calculators');
            
            doseMenu.classList.remove('show');
            mobileOverlay.classList.remove('show');
            doseCalculators.classList.remove('open');
            document.body.style.overflow = ''; // Re-enable scrolling
            
            isDoseMenuOpen = false;
        }
        
        // Select dose calculator from menu
        function selectDoseCalculator(calculatorId) {
            showCalculator(calculatorId);
            closeDoseMenu();
        }
        
        // Close menu when clicking outside (for desktop)
        document.addEventListener('click', function(event) {
            const doseCalculators = document.querySelector('.dose-calculators');
            const isClickInside = doseCalculators.contains(event.target);
            
            if (!isClickInside && isDoseMenuOpen && window.innerWidth > 768) {
                closeDoseMenu();
            }
        });
        
        // Handle escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && isDoseMenuOpen) {
                closeDoseMenu();
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768 && isDoseMenuOpen) {
                // Remove mobile overlay if window becomes larger
                const mobileOverlay = document.getElementById('mobile-overlay');
                mobileOverlay.classList.remove('show');
                document.body.style.overflow = '';
            }
        });

        // Modal functionality
        function openModal(modalId) {
            const modal = document.getElementById(modalId + '-modal');
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId + '-modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        // Close modal when clicking outside of it
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                document.body.style.overflow = '';
            }
        });

        // Close modal with escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal');
                openModals.forEach(modal => {
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                        document.body.style.overflow = '';
                    }
                });
            }
        });

        // Utility functions
        function showWarning(message, type = 'warning') {
            const warningClass = type === 'danger' ? 'warning danger' : 'warning';
            return `<div class="${warningClass}"><h4>${type === 'danger' ? '⚠️ Danger' : '⚠️ Warning'}</h4><p>${message}</p></div>`;
        }

        function validateWeight(weight) {
            return weight >= 40 && weight <= 150;
        }

        function getGenderMultiplier(gender, substance) {
            const multipliers = {
                'mdma': { male: 1.0, female: 0.85 },
                'lsd': { male: 1.0, female: 0.9 },
                'ghb': { male: 1.0, female: 0.8 },
                'amphetamines': { male: 1.0, female: 0.85 },
                'cocaine': { male: 1.0, female: 0.85 }
            };
            return multipliers[substance] ? multipliers[substance][gender] || 1.0 : 1.0;
        }

        // Enhanced liquid dosage calculator
        function calculateLiquidDose() {
            const totalVolume = parseFloat(document.getElementById('total-volume').value);
            const totalMedication = parseFloat(document.getElementById('total-medication').value);
            const drugPurity = parseFloat(document.getElementById('drug-purity').value);
            const targetVolume = parseFloat(document.getElementById('target-volume').value);
            const resultValue = document.getElementById('liquid-result-value');
            const resultDiv = document.getElementById('liquid-result');

            if (isNaN(totalVolume) || isNaN(totalMedication) || isNaN(targetVolume) || isNaN(drugPurity) || 
                totalVolume <= 0 || drugPurity < 0 || drugPurity > 100) {
                resultValue.innerHTML = 'Please enter valid numbers. Total volume must be > 0. Purity must be between 0 and 100.';
                resultDiv.style.display = 'block';
                return;
            }

            const result = (totalMedication * 1000) / totalVolume * targetVolume * (drugPurity / 100);
            resultValue.innerHTML = `${result.toFixed(2)} mg`;
            resultDiv.style.display = 'block';
        }

        // Enhanced MDMA calculator
        function calculateMDMA() {
            const weight = parseFloat(document.getElementById('mdma-weight').value);
            const gender = document.getElementById('mdma-gender').value;
            const experience = document.getElementById('mdma-experience').value;
            const intensity = document.getElementById('mdma-intensity').value;
            const lastUse = parseFloat(document.getElementById('mdma-last-use').value) || 90;
            const setting = document.getElementById('mdma-setting').value;
            const resultValue = document.getElementById('mdma-result-value');
            const resultDetails = document.getElementById('mdma-details');
            const resultDiv = document.getElementById('mdma-result');

            if (!validateWeight(weight) || !gender || !experience || !intensity || !setting) {
                resultValue.innerHTML = 'Please fill in all fields with valid values.';
                resultDetails.innerHTML = '';
                resultDiv.style.display = 'block';
                return;
            }

            // Enhanced dosage calculation based on research
            const intensityDoses = {
                'threshold': { base: 0.8, max: 1.0 },  // 56-70mg for 70kg
                'light': { base: 1.0, max: 1.3 },      // 70-91mg for 70kg
                'common': { base: 1.3, max: 1.7 },     // 91-119mg for 70kg
                'strong': { base: 1.7, max: 2.2 }      // 119-154mg for 70kg
            };

            const experienceMultiplier = {
                'beginner': 0.75,     // Lower dose for safety
                'experienced': 1.0,   // Standard dose
                'expert': 1.1         // Slightly higher due to tolerance
            };

            // Gender-based metabolism differences
            const genderMultiplier = {
                'male': 1.0,
                'female': 0.83,       // Lower dose due to typically lower body water content
                'other': 0.9          // Conservative approach
            };

            // Setting-based adjustments for safety
            const settingMultiplier = {
                'home': 1.0,          // Safest environment
                'therapy': 0.9,       // Therapeutic doses are typically lower
                'club': 0.85,         // High-energy environment, risk of overheating
                'festival': 0.8       // Outdoor, physical activity, dehydration risk
            };

            // Calculate base dose
            let baseDose = weight * intensityDoses[intensity].base;
            let maxDose = weight * intensityDoses[intensity].max;

            // Apply multipliers
            baseDose *= experienceMultiplier[experience] * genderMultiplier[gender] * settingMultiplier[setting];
            maxDose *= experienceMultiplier[experience] * genderMultiplier[gender] * settingMultiplier[setting];

            // Tolerance factor based on time since last use
            let toleranceFactor = 1.0;
            if (lastUse < 30) {
                toleranceFactor = 1.4; // Significant tolerance
            } else if (lastUse < 60) {
                toleranceFactor = 1.2; // Moderate tolerance
            } else if (lastUse < 90) {
                toleranceFactor = 1.1; // Mild tolerance
            }

            baseDose *= toleranceFactor;
            maxDose *= toleranceFactor;

            // Safety caps (absolute maximum limits)
            const absoluteMaxByWeight = Math.min(200, weight * 2.5);
            const safeDose = Math.min(baseDose, absoluteMaxByWeight);
            const safeMaxDose = Math.min(maxDose, absoluteMaxByWeight);

            // Generate warnings based on multiple factors
            let warnings = '';
            let riskLevel = 'low';

            // Dose-based warnings
            if (safeDose > 180) {
                warnings += showWarning('EXTREMELY HIGH DOSE - Serious risk of hyperthermia, serotonin syndrome, and cardiovascular issues!', 'danger');
                riskLevel = 'extreme';
            } else if (safeDose > 150) {
                warnings += showWarning('Very high dose - Exercise extreme caution! Have medical support available.', 'danger');
                riskLevel = 'high';
            } else if (safeDose > 120) {
                warnings += showWarning('Moderate-high dose - Stay hydrated, monitor body temperature, have a sober friend present.');
                riskLevel = 'moderate';
            }

            // Experience-based warnings
            if (experience === 'beginner' && intensity === 'strong') {
                warnings += showWarning('Strong doses not recommended for beginners. Consider starting with light or common intensity.');
            }

            // Frequency-based warnings
            if (lastUse < 30) {
                warnings += showWarning('VERY RECENT USE - High risk of neurotoxicity and reduced effects. Wait at least 3 months between uses!', 'danger');
            } else if (lastUse < 90) {
                warnings += showWarning('Recent use detected - Consider waiting longer for full serotonin recovery (3+ months recommended).');
            }

            // Setting-based warnings
            if (setting === 'club' || setting === 'festival') {
                warnings += showWarning('High-energy environment - Extra attention to hydration, cooling, and electrolyte balance required.');
            }

            // Calculate redose recommendation
            const redose = Math.round(safeDose * 0.4); // 40% of initial dose
            const totalSessionDose = safeDose + redose;

            // Duration and timeline information
            const timeline = {
                onset: '30-60 minutes',
                peak: '1.5-2.5 hours after onset',
                duration: '4-6 hours total',
                redoseWindow: '1.5-2 hours after initial dose'
            };

            // Risk color coding
            const riskColors = {
                'low': '#10b981',      // Green
                'moderate': '#f59e0b', // Orange
                'high': '#ef4444',     // Red
                'extreme': '#7c2d12'   // Dark red
            };

            resultValue.innerHTML = `<span style="color: ${riskColors[riskLevel]}">${Math.round(safeDose)}mg</span>`;
            
            resultDetails.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.75rem;">💊 Dosage Information</h4>
                        <p><strong>Initial dose:</strong> ${Math.round(safeDose)}mg</p>
                        <p><strong>Optional redose:</strong> ${redose}mg (if needed)</p>
                        <p><strong>Max session total:</strong> ${Math.round(totalSessionDose)}mg</p>
                        <p><strong>Dose per kg:</strong> ${(safeDose/weight).toFixed(1)}mg/kg</p>
                    </div>
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.75rem;">⏱️ Timeline</h4>
                        <p><strong>Onset:</strong> ${timeline.onset}</p>
                        <p><strong>Peak effects:</strong> ${timeline.peak}</p>
                        <p><strong>Total duration:</strong> ${timeline.duration}</p>
                        <p><strong>Redose window:</strong> ${timeline.redoseWindow}</p>
                    </div>
                </div>
                
                <div style="background: var(--background-secondary); padding: 1.25rem; border-radius: var(--radius-md); margin: 1.5rem 0;">
                    <h4 style="color: var(--success-color); margin-bottom: 1rem;">🛡️ Safety Guidelines for ${setting.charAt(0).toUpperCase() + setting.slice(1)} Setting</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <strong>Before:</strong><br>
                            • Test your substance with reagents<br>
                            • Eat a light meal 2-3 hours prior<br>
                            • Get adequate sleep the night before<br>
                            • Avoid alcohol and other drugs
                        </div>
                        <div>
                            <strong>During:</strong><br>
                            • Stay hydrated (but don't overdrink)<br>
                            • Take breaks in cool areas<br>
                            • Have a trusted sober friend present<br>
                            • Monitor body temperature
                        </div>
                        <div>
                            <strong>After:</strong><br>
                            • Get plenty of rest<br>
                            • Eat nutritious foods<br>
                            • Consider 5-HTP supplementation<br>
                            • Wait at least 3 months before next use
                        </div>
                    </div>
                </div>
                
                <div class="scientific-note">
                    <strong>Enhanced Calculation Factors:</strong><br>
                    • Weight-based dosing: ${(intensityDoses[intensity].base).toFixed(1)}-${(intensityDoses[intensity].max).toFixed(1)}mg/kg base range<br>
                    • Experience adjustment: ${(experienceMultiplier[experience] * 100).toFixed(0)}% of standard dose<br>
                    • Gender metabolic factor: ${(genderMultiplier[gender] * 100).toFixed(0)}% adjustment<br>
                    • Setting safety factor: ${(settingMultiplier[setting] * 100).toFixed(0)}% adjustment<br>
                    • Tolerance consideration: ${(toleranceFactor * 100).toFixed(0)}% increase (${lastUse} days since last use)<br>
                    • Risk level: <strong style="color: ${riskColors[riskLevel]}">${riskLevel.toUpperCase()}</strong>
                </div>
                
                ${warnings}
            `;
            resultDiv.style.display = 'block';
        }

        // Enhanced LSD calculator
        function calculateLSD() {
            const weight = parseFloat(document.getElementById('lsd-weight').value);
            const gender = document.getElementById('lsd-gender').value;
            const experience = document.getElementById('lsd-experience').value;
            const intensity = document.getElementById('lsd-intensity').value;
            const lastPsychedelic = parseFloat(document.getElementById('lsd-last-psychedelic').value) || 14;
            const setting = document.getElementById('lsd-setting').value;
            const resultValue = document.getElementById('lsd-result-value');
            const resultDetails = document.getElementById('lsd-details');
            const resultDiv = document.getElementById('lsd-result');

            if (!validateWeight(weight) || !gender || !experience || !intensity || !setting) {
                resultValue.innerHTML = 'Please fill in all fields with valid values.';
                resultDetails.innerHTML = '';
                resultDiv.style.display = 'block';
                return;
            }

            // Enhanced dosage calculation with more precise ranges
            const intensityDoses = {
                'microdose': { dose: 8, range: '5-12' },      // Sub-perceptual
                'threshold': { dose: 25, range: '20-30' },    // Barely noticeable
                'light': { dose: 50, range: '40-75' },        // Clear psychedelic effects
                'common': { dose: 100, range: '75-150' },     // Full LSD experience
                'strong': { dose: 200, range: '150-300' },    // Strong visuals and headspace
                'heavy': { dose: 350, range: '300-500' }      // Overwhelming intensity
            };

            const experienceMultiplier = {
                'beginner': 0.7,      // Conservative for safety
                'experienced': 1.0,   // Standard dosing
                'expert': 1.15        // Can handle slightly higher doses
            };

            // Gender-based sensitivity differences (minimal for LSD)
            const genderMultiplier = {
                'male': 1.0,
                'female': 0.92,       // Slightly higher sensitivity reported
                'other': 0.95         // Conservative approach
            };

            // Setting-based adjustments for safety and appropriateness
            const settingMultiplier = {
                'controlled': 1.0,    // Therapeutic/controlled setting
                'home': 0.95,         // Safe but less controlled
                'nature': 0.9,        // Beautiful but potentially challenging
                'festival': 0.8       // Stimulating but potentially overwhelming
            };

            // Calculate base dose
            let dose = intensityDoses[intensity].dose;

            // Apply multipliers
            dose *= experienceMultiplier[experience] * genderMultiplier[gender] * settingMultiplier[setting];

            // Minimal weight adjustment for LSD (weak correlation)
            const weightFactor = Math.pow(weight / 70, 0.25); // Very weak weight dependence
            dose *= weightFactor;

            // Tolerance factor based on time since last psychedelic use
            let toleranceFactor = 1.0;
            if (lastPsychedelic < 3) {
                toleranceFactor = 2.5;  // Very high tolerance
            } else if (lastPsychedelic < 7) {
                toleranceFactor = 1.8;  // High tolerance
            } else if (lastPsychedelic < 14) {
                toleranceFactor = 1.3;  // Moderate tolerance
            }

            dose *= toleranceFactor;

            // Safety caps
            const maxSafeDose = intensity === 'microdose' ? 15 : 
                               intensity === 'threshold' ? 40 :
                               intensity === 'light' ? 100 :
                               intensity === 'common' ? 200 :
                               intensity === 'strong' ? 350 : 500;

            dose = Math.min(dose, maxSafeDose);

            // Generate warnings and risk assessment
            let warnings = '';
            let riskLevel = 'low';

            // Dose-based warnings
            if (dose > 300) {
                warnings += showWarning('VERY HIGH DOSE - Risk of overwhelming experience, panic, and dangerous behavior!', 'danger');
                riskLevel = 'extreme';
            } else if (dose > 200) {
                warnings += showWarning('High dose - Intense experience likely. Ensure experienced sitter present.', 'danger');
                riskLevel = 'high';
            } else if (dose > 150) {
                warnings += showWarning('Strong dose - Significant psychedelic effects. Safe environment essential.');
                riskLevel = 'moderate';
            }

            // Experience-based warnings
            if (experience === 'beginner' && ['strong', 'heavy'].includes(intensity)) {
                warnings += showWarning('High doses not recommended for beginners. Start with threshold or light doses.');
            }

            // Tolerance-based warnings
            if (lastPsychedelic < 7) {
                warnings += showWarning('VERY RECENT PSYCHEDELIC USE - Tolerance is likely very high. Effects may be minimal despite high dose!', 'danger');
            } else if (lastPsychedelic < 14) {
                warnings += showWarning('Recent psychedelic use - Tolerance may reduce effects. Consider waiting longer.');
            }

            // Setting-based warnings
            if (setting === 'festival' && ['common', 'strong', 'heavy'].includes(intensity)) {
                warnings += showWarning('High doses in festival settings can be overwhelming. Consider lower dose or safer setting.');
            }

            // Experience timeline based on dose
            const timeline = {
                microdose: {
                    onset: '60-90 minutes',
                    peak: '3-5 hours',
                    duration: '6-8 hours',
                    afterglow: '1-2 days'
                },
                threshold: {
                    onset: '45-75 minutes',
                    peak: '2-4 hours',
                    duration: '8-10 hours',
                    afterglow: '1-2 days'
                },
                light: {
                    onset: '30-60 minutes',
                    peak: '2-4 hours',
                    duration: '8-12 hours',
                    afterglow: '1-3 days'
                },
                common: {
                    onset: '30-60 minutes',
                    peak: '3-5 hours',
                    duration: '10-12 hours',
                    afterglow: '2-4 days'
                },
                strong: {
                    onset: '20-45 minutes',
                    peak: '4-6 hours',
                    duration: '12-16 hours',
                    afterglow: '3-7 days'
                },
                heavy: {
                    onset: '15-30 minutes',
                    peak: '5-8 hours',
                    duration: '14-18 hours',
                    afterglow: '5-10 days'
                }
            };

            const currentTimeline = timeline[intensity];

            // Risk color coding
            const riskColors = {
                'low': '#10b981',
                'moderate': '#f59e0b',
                'high': '#ef4444',
                'extreme': '#7c2d12'
            };

            resultValue.innerHTML = `<span style="color: ${riskColors[riskLevel]}">${Math.round(dose)} µg</span>`;

            resultDetails.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.75rem;">💊 Dosage Information</h4>
                        <p><strong>Recommended dose:</strong> ${Math.round(dose)} µg</p>
                        <p><strong>Typical range:</strong> ${intensityDoses[intensity].range} µg</p>
                        <p><strong>Intensity level:</strong> ${intensity.charAt(0).toUpperCase() + intensity.slice(1)}</p>
                        <p><strong>Risk level:</strong> <span style="color: ${riskColors[riskLevel]}">${riskLevel.toUpperCase()}</span></p>
                    </div>
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.75rem;">⏱️ Timeline</h4>
                        <p><strong>Onset:</strong> ${currentTimeline.onset}</p>
                        <p><strong>Peak effects:</strong> ${currentTimeline.peak}</p>
                        <p><strong>Total duration:</strong> ${currentTimeline.duration}</p>
                        <p><strong>Afterglow:</strong> ${currentTimeline.afterglow}</p>
                    </div>
                </div>

                <div style="background: var(--background-secondary); padding: 1.25rem; border-radius: var(--radius-md); margin: 1.5rem 0;">
                    <h4 style="color: var(--primary-color); margin-bottom: 1rem;">🧠 Expected Effects for ${intensity.charAt(0).toUpperCase() + intensity.slice(1)} Dose</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        ${getExpectedEffects(intensity)}
                    </div>
                </div>
                
                <div style="background: var(--background-secondary); padding: 1.25rem; border-radius: var(--radius-md); margin: 1.5rem 0;">
                    <h4 style="color: var(--success-color); margin-bottom: 1rem;">🛡️ Safety Guidelines for ${setting.charAt(0).toUpperCase() + setting.slice(1)} Setting</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <strong>Preparation:</strong><br>
                            • Clear schedule for next 24 hours<br>
                            • Comfortable, safe environment<br>
                            • Trusted, experienced trip sitter<br>
                            • Emergency contacts ready
                        </div>
                        <div>
                            <strong>During:</strong><br>
                            • Stay hydrated with water<br>
                            • Have light snacks available<br>
                            • Avoid driving or dangerous activities<br>
                            • Change setting if uncomfortable
                        </div>
                        <div>
                            <strong>Integration:</strong><br>
                            • Journal your experience<br>
                            • Discuss insights with trusted friends<br>
                            • Wait 2+ weeks before next psychedelic<br>
                            • Consider therapy if processing is needed
                        </div>
                    </div>
                </div>
                
                <div class="scientific-note">
                    <strong>Enhanced Calculation Factors:</strong><br>
                    • Base dose for ${intensity}: ${intensityDoses[intensity].dose} µg<br>
                    • Experience adjustment: ${(experienceMultiplier[experience] * 100).toFixed(0)}% of standard dose<br>
                    • Gender sensitivity factor: ${(genderMultiplier[gender] * 100).toFixed(0)}% adjustment<br>
                    • Setting safety factor: ${(settingMultiplier[setting] * 100).toFixed(0)}% adjustment<br>
                    • Weight correlation: ${(weightFactor * 100).toFixed(0)}% (minimal effect)<br>
                    • Tolerance factor: ${(toleranceFactor * 100).toFixed(0)}% (${lastPsychedelic} days since last psychedelic)
                </div>
                
                ${warnings}
            `;
            resultDiv.style.display = 'block';
        }

        // Helper function for expected effects
        function getExpectedEffects(intensity) {
            const effects = {
                'microdose': `
                    <div><strong>Physical:</strong><br>Slight energy increase, enhanced colors</div>
                    <div><strong>Mental:</strong><br>Improved focus, slight mood lift</div>
                    <div><strong>Visual:</strong><br>Subtle color enhancement</div>
                `,
                'threshold': `
                    <div><strong>Physical:</strong><br>Light body sensations, mild euphoria</div>
                    <div><strong>Mental:</strong><br>Slight thought changes, enhanced creativity</div>
                    <div><strong>Visual:</strong><br>Mild breathing walls, color shifts</div>
                `,
                'light': `
                    <div><strong>Physical:</strong><br>Clear body high, energy fluctuations</div>
                    <div><strong>Mental:</strong><br>Noticeable thought patterns, mild confusion</div>
                    <div><strong>Visual:</strong><br>Clear visual distortions, pattern recognition</div>
                `,
                'common': `
                    <div><strong>Physical:</strong><br>Strong body sensations, possible nausea</div>
                    <div><strong>Mental:</strong><br>Altered thinking, emotional intensity</div>
                    <div><strong>Visual:</strong><br>Strong visuals, geometric patterns</div>
                `,
                'strong': `
                    <div><strong>Physical:</strong><br>Intense body load, temperature changes</div>
                    <div><strong>Mental:</strong><br>Deep introspection, ego dissolution</div>
                    <div><strong>Visual:</strong><br>Complex visuals, reality distortion</div>
                `,
                'heavy': `
                    <div><strong>Physical:</strong><br>Overwhelming sensations, motor impairment</div>
                    <div><strong>Mental:</strong><br>Complete ego loss, mystical experiences</div>
                    <div><strong>Visual:</strong><br>Total visual replacement, entity contact</div>
                `
            };
            return effects[intensity] || '';
        }

        // Enhanced ketamine calculator with comprehensive factors
        function calculateKetamine() {
            const weight = parseFloat(document.getElementById('ket-weight').value);
            const gender = document.getElementById('ket-gender').value;
            const experience = document.getElementById('ket-experience').value;
            const route = document.getElementById('ket-route').value;
            const intensity = document.getElementById('ket-intensity').value;
            const lastUse = parseFloat(document.getElementById('ket-last-use').value) || 7;
            const setting = document.getElementById('ket-setting').value;
            const toleranceHistory = document.getElementById('ket-tolerance-history').value;
            const resultValue = document.getElementById('ket-result-value');
            const resultDetails = document.getElementById('ket-details');
            const resultDiv = document.getElementById('ketamine-result');

            if (!validateWeight(weight) || !gender || !experience || !route || !intensity || !setting || !toleranceHistory) {
                resultValue.innerHTML = 'Please fill in all fields with valid values.';
                resultDetails.innerHTML = '';
                resultDiv.style.display = 'block';
                return;
            }

            // CORRECTED dosage calculation based on route and intensity - FIXED DANGEROUS OVER-DOSING
            const intensityDoses = {
                'threshold': { oral: 0.4, nasal: 0.25, sublingual: 0.3, intramuscular: 0.2, intravenous: 0.15 },
                'light': { oral: 0.8, nasal: 0.5, sublingual: 0.6, intramuscular: 0.4, intravenous: 0.25 },
                'common': { oral: 1.2, nasal: 0.8, sublingual: 1.0, intramuscular: 0.6, intravenous: 0.4 },
                'strong': { oral: 1.8, nasal: 1.2, sublingual: 1.5, intramuscular: 0.9, intravenous: 0.6 },
                'k-hole': { oral: 2.5, nasal: 1.8, sublingual: 2.2, intramuscular: 1.3, intravenous: 0.9 }
            };

            const experienceMultiplier = {
                'beginner': 0.7,      // Conservative dosing for safety
                'experienced': 1.0,   // Standard dosing
                'expert': 1.2         // Can handle higher doses
            };

            // Gender-based metabolism differences (smaller than other substances)
            const genderMultiplier = {
                'male': 1.0,
                'female': 0.85,       // Generally lower dose needed
                'other': 0.9          // Conservative approach
            };

            // Setting-based safety adjustments
            const settingMultiplier = {
                'home': 1.0,          // Safest environment
                'therapeutic': 0.8,   // Medical setting, lower recreational doses
                'party': 0.7,         // Social setting, need to stay functional
                'club': 0.6           // High-stimulation environment, safety priority
            };

            // Tolerance history adjustments - REDUCED to prevent dangerous stacking
            const toleranceMultiplier = {
                'none': 1.0,          // No tolerance
                'occasional': 1.1,    // Slight tolerance - REDUCED from 1.15
                'regular': 1.2,       // Moderate tolerance - REDUCED from 1.4
                'frequent': 1.3       // High tolerance - REDUCED from 1.8
            };

            // Calculate base dose (mg/kg for route)
            let baseDose = weight * intensityDoses[intensity][route];

            // Apply all multipliers
            baseDose *= experienceMultiplier[experience] * genderMultiplier[gender] * settingMultiplier[setting];

            // Recent use tolerance factor - REDUCED to prevent dangerous escalation
            let recentToleranceFactor = 1.0;
            if (lastUse < 2) {
                recentToleranceFactor = 1.3; // High tolerance - REDUCED from 1.6
            } else if (lastUse < 5) {
                recentToleranceFactor = 1.15; // Moderate tolerance - REDUCED from 1.3
            } else if (lastUse < 10) {
                recentToleranceFactor = 1.05; // Mild tolerance - REDUCED from 1.1
            }

            // Apply tolerance factors with safety cap to prevent dangerous escalation
            baseDose *= toleranceMultiplier[toleranceHistory] * recentToleranceFactor;
            
            // SAFETY CAP: Never recommend more than 2.5x base dose regardless of tolerance
            const originalBaseDose = weight * intensityDoses[intensity][route];
            const maxToleranceDose = originalBaseDose * 2.5;
            if (baseDose > maxToleranceDose) {
                baseDose = maxToleranceDose;
                warnings += showWarning('Dose capped at 2.5x base due to safety concerns. Consider taking a longer break to reset tolerance.', 'danger');
            }

            // Safety caps by route - REDUCED to safer levels
            const maxSafeDose = {
                'oral': weight * 3,     // REDUCED from weight * 8
                'nasal': weight * 2,    // REDUCED from weight * 5  
                'sublingual': weight * 2.5, // REDUCED from weight * 6
                'intramuscular': weight * 1.5, // REDUCED from weight * 3
                'intravenous': weight * 1   // REDUCED from weight * 2
            };

            const safeDose = Math.min(baseDose, maxSafeDose[route]);

            // Generate warnings based on multiple factors
            let warnings = '';
            let riskLevel = 'low';

            // Route-specific warnings
            if (route === 'intravenous') {
                warnings += showWarning('IV administration carries extreme risks! Medical supervision required. Risk of infection, overdose, and vascular damage.', 'danger');
                riskLevel = 'extreme';
            } else if (route === 'intramuscular') {
                warnings += showWarning('IM injection requires sterile technique and medical knowledge. High risk if done improperly.', 'danger');
                riskLevel = 'high';
            }

            // Dose-based warnings
            if (safeDose > weight * 3 && !['intravenous', 'intramuscular'].includes(route)) {
                warnings += showWarning('Very high dose - risk of prolonged dissociation and respiratory depression!', 'danger');
                riskLevel = 'high';
            } else if (safeDose > weight * 2 && !['intravenous', 'intramuscular'].includes(route)) {
                warnings += showWarning('High dose - ensure experienced sitter present and safe environment.');
                riskLevel = 'moderate';
            }

            // Experience vs intensity warnings
            if (experience === 'beginner' && ['strong', 'k-hole'].includes(intensity)) {
                warnings += showWarning('High-intensity experiences not recommended for beginners. Start with light or common doses.');
            }

            // Frequency warnings
            if (toleranceHistory === 'frequent') {
                warnings += showWarning('Frequent ketamine use can cause serious bladder damage and psychological dependence. Consider harm reduction resources.', 'danger');
            } else if (toleranceHistory === 'regular') {
                warnings += showWarning('Regular ketamine use increases risk of tolerance and urinary tract damage. Monitor usage frequency.');
            }

            // Recent use warnings
            if (lastUse < 3) {
                warnings += showWarning('Very recent use - high tolerance likely. Effects may be diminished despite increased dose.');
            }

            // K-hole specific warnings
            if (intensity === 'k-hole') {
                warnings += showWarning('K-hole doses cause complete dissociation. Experienced sitter essential. Risk of injury from inability to move.', 'danger');
            }

            // Timeline and duration info
            const routeInfo = {
                'oral': { onset: '45-90 minutes', peak: '1.5-3 hours', duration: '4-6 hours', bioavailability: '20-25%' },
                'nasal': { onset: '10-20 minutes', peak: '30-60 minutes', duration: '2-3 hours', bioavailability: '45-50%' },
                'sublingual': { onset: '15-30 minutes', peak: '45-90 minutes', duration: '2.5-4 hours', bioavailability: '30-35%' },
                'intramuscular': { onset: '5-15 minutes', peak: '20-40 minutes', duration: '1.5-3 hours', bioavailability: '85-95%' },
                'intravenous': { onset: '1-3 minutes', peak: '5-15 minutes', duration: '1-2 hours', bioavailability: '100%' }
            };

            const currentRoute = routeInfo[route];

            // Risk color coding
            const riskColors = {
                'low': '#10b981',
                'moderate': '#f59e0b',
                'high': '#ef4444',
                'extreme': '#7c2d12'
            };

            resultValue.innerHTML = `<span style="color: ${riskColors[riskLevel]}">${Math.round(safeDose)}mg</span>`;
            
            resultDetails.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.75rem;">💊 Dosage Information</h4>
                        <p><strong>Recommended dose:</strong> ${Math.round(safeDose)}mg</p>
                        <p><strong>Route:</strong> ${route.charAt(0).toUpperCase() + route.slice(1)}</p>
                        <p><strong>Dose per kg:</strong> ${(safeDose/weight).toFixed(1)}mg/kg</p>
                        <p><strong>Bioavailability:</strong> ${currentRoute.bioavailability}</p>
                        <p><strong>Risk level:</strong> <span style="color: ${riskColors[riskLevel]}">${riskLevel.toUpperCase()}</span></p>
                    </div>
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.75rem;">⏱️ ${route.charAt(0).toUpperCase() + route.slice(1)} Timeline</h4>
                        <p><strong>Onset:</strong> ${currentRoute.onset}</p>
                        <p><strong>Peak effects:</strong> ${currentRoute.peak}</p>
                        <p><strong>Total duration:</strong> ${currentRoute.duration}</p>
                        <p><strong>Intensity:</strong> ${intensity.charAt(0).toUpperCase() + intensity.slice(1)}</p>
                    </div>
                </div>
                
                <div style="background: var(--background-secondary); padding: 1.25rem; border-radius: var(--radius-md); margin: 1.5rem 0;">
                    <h4 style="color: var(--success-color); margin-bottom: 1rem;">🛡️ Safety Guidelines for ${setting.charAt(0).toUpperCase() + setting.slice(1)} Setting</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <strong>Before:</strong><br>
                            • Test substance with reagents<br>
                            • Ensure experienced sitter present<br>
                            • Remove potential hazards from area<br>
                            • Have emergency contacts ready
                        </div>
                        <div>
                            <strong>During:</strong><br>
                            • Stay in safe, comfortable position<br>
                            • Avoid driving or dangerous activities<br>
                            • Monitor breathing and consciousness<br>
                            • Keep environment calm and safe
                        </div>
                        <div>
                            <strong>After:</strong><br>
                            • Allow full recovery before activity<br>
                            • Hydrate and rest adequately<br>
                            • Reflect on experience safely<br>
                            • Wait appropriate time before next use
                        </div>
                    </div>
                </div>
                
                <div class="scientific-note">
                    <strong>Enhanced Calculation Factors:</strong><br>
                    • Base dose (${route}): ${intensityDoses[intensity][route]}mg/kg for ${intensity} intensity<br>
                    • Experience adjustment: ${(experienceMultiplier[experience] * 100).toFixed(0)}% of standard dose<br>
                    • Gender factor: ${(genderMultiplier[gender] * 100).toFixed(0)}% adjustment<br>
                    • Setting safety factor: ${(settingMultiplier[setting] * 100).toFixed(0)}% adjustment<br>
                    • Tolerance history: ${(toleranceMultiplier[toleranceHistory] * 100).toFixed(0)}% increase<br>
                    • Recent use factor: ${(recentToleranceFactor * 100).toFixed(0)}% (${lastUse} days ago)<br>
                    Based on NMDA receptor tolerance patterns and route-specific pharmacokinetics.
                </div>
                
                ${warnings}
            `;
            resultDiv.style.display = 'block';
        }

        // Enhanced GHB/GBL calculator with comprehensive safety factors
        function calculateGHB() {
            const weight = parseFloat(document.getElementById('ghb-weight').value);
            const gender = document.getElementById('ghb-gender').value;
            const substance = document.getElementById('ghb-substance').value;
            const experience = document.getElementById('ghb-experience').value;
            const intensity = document.getElementById('ghb-intensity').value;
            const lastUse = parseFloat(document.getElementById('ghb-last-use').value) || 3;
            const stomach = document.getElementById('ghb-stomach').value;
            const setting = document.getElementById('ghb-setting').value;
            const alcohol = document.getElementById('ghb-alcohol').value;
            const resultValue = document.getElementById('ghb-result-value');
            const resultDetails = document.getElementById('ghb-details');
            const resultDiv = document.getElementById('ghb-result');

            if (!validateWeight(weight) || !gender || !substance || !experience || !intensity || !stomach || !setting || !alcohol) {
                resultValue.innerHTML = 'Please fill in all fields with valid values.';
                resultDetails.innerHTML = '';
                resultDiv.style.display = 'block';
                return;
            }

            // CRITICAL: Check for alcohol consumption first
            if (alcohol !== 'none') {
                resultValue.innerHTML = 'CONTRAINDICATED';
                resultDetails.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(139, 69, 19, 0.2) 0%, rgba(139, 69, 19, 0.1) 100%); border: 2px solid #8B4513; border-radius: var(--radius-lg); padding: 2rem; margin: 1rem 0; text-align: center;">
                        <h3 style="color: #8B4513; margin-bottom: 1rem; font-size: 1.5rem;">⚠️ EXTREMELY DANGEROUS COMBINATION ⚠️</h3>
                        <p style="color: var(--text-primary); font-size: 1.1rem; font-weight: bold; margin-bottom: 1rem;">
                            GHB/GBL + Alcohol = POTENTIALLY FATAL
                        </p>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            This combination causes severe respiratory depression, coma, and death. Wait at least 12-24 hours after any alcohol consumption before considering GHB/GBL use.
                        </p>
                        <p style="color: #8B4513; font-weight: bold;">
                            NO SAFE DOSE EXISTS WITH ALCOHOL IN YOUR SYSTEM
                        </p>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return;
            }

            // Enhanced dosage calculation with safety factors
            const intensityDoses = {
                'threshold': { ghb: 0.5, gbl: 0.35, bdo: 0.6 },    // g/70kg
                'light': { ghb: 1.0, gbl: 0.7, bdo: 1.2 },         // g/70kg
                'common': { ghb: 1.75, gbl: 1.2, bdo: 2.1 },       // g/70kg
                'strong': { ghb: 2.5, gbl: 1.75, bdo: 3.0 }        // g/70kg - DANGEROUS
            };

            const experienceMultiplier = {
                'beginner': 0.6,      // Much more conservative for safety
                'experienced': 0.8,   // Still conservative
                'expert': 1.0         // Standard dosing only for very experienced users
            };

            // Gender-based metabolism differences (significant for GHB)
            const genderMultiplier = {
                'male': 1.0,
                'female': 0.75,       // Significantly lower due to metabolism differences
                'other': 0.8          // Conservative approach
            };

            // Stomach status has major impact on absorption
            const stomachMultiplier = {
                'empty': 1.0,         // Fastest, most dangerous absorption
                'light': 0.7,         // Slower absorption, safer
                'full': 0.5           // Much slower absorption, much safer
            };

            // Setting-based safety adjustments
            const settingMultiplier = {
                'home': 1.0,          // Safest environment
                'therapeutic': 0.6,   // Medical setting, very conservative
                'party': 0.7,         // Need to stay functional and safe
                'club': 0.6           // High-risk environment, very conservative
            };

            // Calculate base dose in grams
            let baseDose = (weight / 70) * intensityDoses[intensity][substance];

            // Apply all safety multipliers
            baseDose *= experienceMultiplier[experience] * genderMultiplier[gender] * stomachMultiplier[stomach] * settingMultiplier[setting];

            // Tolerance factor (GHB tolerance develops rapidly)
            let toleranceFactor = 1.0;
            if (lastUse < 1) {
                toleranceFactor = 1.5; // Significant tolerance
            } else if (lastUse < 3) {
                toleranceFactor = 1.2; // Moderate tolerance
            } else if (lastUse < 7) {
                toleranceFactor = 1.1; // Mild tolerance
            }

            baseDose *= toleranceFactor;

            // STRICT safety caps - GHB has very narrow therapeutic window
            const absoluteMaxDose = {
                'ghb': 3.5,      // Absolute maximum in grams
                'gbl': 2.5,      // More potent
                'bdo': 4.0       // Less potent but still dangerous
            };

            const safeDose = Math.min(baseDose, absoluteMaxDose[substance]);

            // Convert to appropriate units and calculate volume for liquids
            let displayValue, unit;
            if (substance === 'ghb') {
                displayValue = (safeDose * 1000).toFixed(0); // Convert to mg
                unit = 'mg';
            } else {
                // For GBL/BDO, calculate volume (typical concentration ~1g/ml)
                const volumeMl = safeDose; // Approximate 1:1 ratio for pure substances
                displayValue = volumeMl.toFixed(2);
                unit = 'ml';
            }

            // Generate comprehensive warnings
            let warnings = '';
            let riskLevel = 'extreme'; // GHB is always high risk

            // Dose-based warnings
            if (safeDose > absoluteMaxDose[substance] * 0.8) {
                warnings += showWarning('EXTREMELY HIGH DOSE - Life-threatening risk of coma and respiratory failure!', 'danger');
            } else if (safeDose > absoluteMaxDose[substance] * 0.6) {
                warnings += showWarning('Very high dose - Serious risk of unconsciousness and breathing problems!', 'danger');
            } else if (safeDose > absoluteMaxDose[substance] * 0.4) {
                warnings += showWarning('High dose - Significant risk of loss of consciousness!', 'danger');
            }

            // Experience-based warnings
            if (experience === 'beginner') {
                warnings += showWarning('First time users should start with threshold doses and have experienced supervision.', 'danger');
            }

            // Frequency-based warnings
            if (lastUse < 3) {
                warnings += showWarning('Recent use detected - GHB tolerance develops rapidly and increases overdose risk!', 'danger');
            }

            // Stomach warnings
            if (stomach === 'empty') {
                warnings += showWarning('Empty stomach increases absorption speed and overdose risk. Consider eating something light first.');
            }

            // Setting warnings
            if (['party', 'club'].includes(setting)) {
                warnings += showWarning('Social settings increase risks due to distractions and peer pressure. Stay with trusted friends.');
            }

            // Universal GHB warnings
            warnings += showWarning('GHB has an extremely narrow margin between active and dangerous doses. Start low and wait fully before any redose!', 'danger');
            warnings += showWarning('Never combine with alcohol, benzodiazepines, opioids, or any other depressants - potentially fatal!', 'danger');

            // Timeline and safety info
            const substanceInfo = {
                'ghb': {
                    onset: stomach === 'empty' ? '15-30 minutes' : '30-60 minutes',
                    peak: '45-90 minutes',
                    duration: '2-4 hours',
                    redoseWait: '3+ hours',
                    name: 'GHB'
                },
                'gbl': {
                    onset: stomach === 'empty' ? '10-20 minutes' : '20-45 minutes',
                    peak: '30-75 minutes',
                    duration: '2-3.5 hours',
                    redoseWait: '3+ hours',
                    name: 'GBL'
                },
                'bdo': {
                    onset: stomach === 'empty' ? '30-60 minutes' : '60-120 minutes',
                    peak: '1-2 hours',
                    duration: '3-6 hours',
                    redoseWait: '4+ hours',
                    name: '1,4-BDO'
                }
            };

            const currentSubstance = substanceInfo[substance];

            resultValue.innerHTML = `<span style="color: #ef4444">${displayValue} ${unit}</span>`;
            
            resultDetails.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.75rem;">💊 Dosage Information</h4>
                        <p><strong>Substance:</strong> ${currentSubstance.name}</p>
                        <p><strong>Dose:</strong> ${displayValue} ${unit}</p>
                        <p><strong>Dose (grams):</strong> ${safeDose.toFixed(2)}g</p>
                        <p><strong>Intensity:</strong> ${intensity.charAt(0).toUpperCase() + intensity.slice(1)}</p>
                        <p><strong>Risk level:</strong> <span style="color: #ef4444">EXTREME</span></p>
                    </div>
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.75rem;">⏱️ Timeline (${stomach} stomach)</h4>
                        <p><strong>Onset:</strong> ${currentSubstance.onset}</p>
                        <p><strong>Peak effects:</strong> ${currentSubstance.peak}</p>
                        <p><strong>Duration:</strong> ${currentSubstance.duration}</p>
                        <p><strong>Minimum redose wait:</strong> ${currentSubstance.redoseWait}</p>
                    </div>
                </div>
                
                <div style="background: var(--background-secondary); padding: 1.25rem; border-radius: var(--radius-md); margin: 1.5rem 0;">
                    <h4 style="color: #ef4444; margin-bottom: 1rem;">🚨 CRITICAL Safety Guidelines</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <strong>Before:</strong><br>
                            • ZERO alcohol for 12+ hours<br>
                            • Have experienced sitter present<br>
                            • Emergency contacts ready<br>
                            • Remove all dangerous objects
                        </div>
                        <div>
                            <strong>During:</strong><br>
                            • Take dose ALL AT ONCE<br>
                            • Set timer for redose safety<br>
                            • Stay in safe position<br>
                            • Monitor consciousness/breathing
                        </div>
                        <div>
                            <strong>Emergency:</strong><br>
                            • Call emergency services if unconscious<br>
                            • Recovery position if vomiting<br>
                            • Never leave person alone<br>
                            • Be honest with medical staff
                        </div>
                    </div>
                </div>
                
                <div class="scientific-note">
                    <strong>Enhanced Calculation Factors:</strong><br>
                    • Base dose: ${intensityDoses[intensity][substance]}g/70kg for ${intensity} intensity<br>
                    • Experience safety factor: ${(experienceMultiplier[experience] * 100).toFixed(0)}% of standard dose<br>
                    • Gender metabolic factor: ${(genderMultiplier[gender] * 100).toFixed(0)}% adjustment<br>
                    • Stomach absorption factor: ${(stomachMultiplier[stomach] * 100).toFixed(0)}% (${stomach} stomach)<br>
                    • Setting safety factor: ${(settingMultiplier[setting] * 100).toFixed(0)}% adjustment<br>
                    • Tolerance factor: ${(toleranceFactor * 100).toFixed(0)}% (${lastUse} days since last use)<br>
                    GHB acts on GABA-B receptors with extremely narrow therapeutic window.
                </div>
                
                ${warnings}
            `;
            resultDiv.style.display = 'block';
        }

        // Enhanced amphetamines calculator with comprehensive factors
        function calculateAmphetamines() {
            const weight = parseFloat(document.getElementById('amp-weight').value);
            const gender = document.getElementById('amp-gender').value;
            const substance = document.getElementById('amp-substance').value;
            const experience = document.getElementById('amp-experience').value;
            const route = document.getElementById('amp-route').value;
            const intensity = document.getElementById('amp-intensity').value;
            const lastUse = parseFloat(document.getElementById('amp-last-use').value) || 7;
            const setting = document.getElementById('amp-setting').value;
            const health = document.getElementById('amp-health').value;
            const resultValue = document.getElementById('amp-result-value');
            const resultDetails = document.getElementById('amp-details');
            const resultDiv = document.getElementById('amp-result');

            if (!validateWeight(weight) || !gender || !substance || !experience || !route || !intensity || !setting || !health) {
                resultValue.innerHTML = 'Please fill in all fields with valid values.';
                resultDetails.innerHTML = '';
                resultDiv.style.display = 'block';
                return;
            }

            // CRITICAL: Check cardiovascular health first
            if (health === 'serious') {
                resultValue.innerHTML = 'CONTRAINDICATED';
                resultDetails.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(139, 69, 19, 0.2) 0%, rgba(139, 69, 19, 0.1) 100%); border: 2px solid #8B4513; border-radius: var(--radius-lg); padding: 2rem; margin: 1rem 0; text-align: center;">
                        <h3 style="color: #8B4513; margin-bottom: 1rem; font-size: 1.5rem;">⚠️ SERIOUS HEALTH RISK ⚠️</h3>
                        <p style="color: var(--text-primary); font-size: 1.1rem; font-weight: bold; margin-bottom: 1rem;">
                            Stimulants + Cardiovascular Issues = DANGEROUS
                        </p>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Amphetamines can cause heart attacks, strokes, and arrhythmias in people with cardiovascular conditions. Please consult a medical professional.
                        </p>
                        <p style="color: #8B4513; font-weight: bold;">
                            NO SAFE DOSE FOR SERIOUS HEART CONDITIONS
                        </p>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return;
            }

            // CORRECTED dosage calculation - FIXED DANGEROUS OVER-DOSING
            const intensityDoses = {
                'threshold': { 
                    'amphetamine': { oral: 0.04, nasal: 0.03, sublingual: 0.035, rectal: 0.035, intravenous: 0.02, smoked: 0.02 },
                    'dextroamphetamine': { oral: 0.03, nasal: 0.02, sublingual: 0.025, rectal: 0.025, intravenous: 0.015, smoked: 0.015 },
                    'methamphetamine': { oral: 0.02, nasal: 0.01, sublingual: 0.015, rectal: 0.015, intravenous: 0.008, smoked: 0.008 },
                    'adderall': { oral: 0.035, nasal: 0.025, sublingual: 0.03, rectal: 0.03, intravenous: 0.018, smoked: 0.018 }
                },
                'light': {
                    'amphetamine': { oral: 0.08, nasal: 0.06, sublingual: 0.07, rectal: 0.07, intravenous: 0.04, smoked: 0.04 },
                    'dextroamphetamine': { oral: 0.06, nasal: 0.045, sublingual: 0.055, rectal: 0.055, intravenous: 0.03, smoked: 0.03 },
                    'methamphetamine': { oral: 0.04, nasal: 0.03, sublingual: 0.035, rectal: 0.035, intravenous: 0.02, smoked: 0.02 },
                    'adderall': { oral: 0.07, nasal: 0.05, sublingual: 0.06, rectal: 0.06, intravenous: 0.035, smoked: 0.035 }
                },
                'common': {
                    'amphetamine': { oral: 0.15, nasal: 0.11, sublingual: 0.13, rectal: 0.13, intravenous: 0.08, smoked: 0.08 },
                    'dextroamphetamine': { oral: 0.11, nasal: 0.08, sublingual: 0.095, rectal: 0.095, intravenous: 0.06, smoked: 0.06 },
                    'methamphetamine': { oral: 0.08, nasal: 0.06, sublingual: 0.07, rectal: 0.07, intravenous: 0.04, smoked: 0.04 },
                    'adderall': { oral: 0.13, nasal: 0.095, sublingual: 0.11, rectal: 0.11, intravenous: 0.07, smoked: 0.07 }
                },
                'strong': {
                    'amphetamine': { oral: 0.25, nasal: 0.18, sublingual: 0.21, rectal: 0.21, intravenous: 0.13, smoked: 0.13 },
                    'dextroamphetamine': { oral: 0.18, nasal: 0.13, sublingual: 0.15, rectal: 0.15, intravenous: 0.09, smoked: 0.09 },
                    'methamphetamine': { oral: 0.13, nasal: 0.09, sublingual: 0.11, rectal: 0.11, intravenous: 0.07, smoked: 0.07 },
                    'adderall': { oral: 0.21, nasal: 0.15, sublingual: 0.18, rectal: 0.18, intravenous: 0.11, smoked: 0.11 }
                }
            };

            const experienceMultiplier = {
                'beginner': 0.6,      // Much more conservative for safety
                'experienced': 0.8,   // Moderately conservative
                'expert': 1.0         // Standard dosing
            };

            // Gender-based metabolism differences
            const genderMultiplier = {
                'male': 1.0,
                'female': 0.8,        // Generally lower dose needed
                'other': 0.85         // Conservative approach
            };

            // Setting-based safety adjustments
            const settingMultiplier = {
                'home': 1.0,          // Safe environment
                'work': 0.7,          // Need to stay functional
                'therapeutic': 0.6,   // Medical setting, conservative
                'party': 0.8,         // Social setting, moderate reduction
                'club': 0.7           // High-stimulation environment
            };

            // Health-based safety reductions
            const healthMultiplier = {
                'healthy': 1.0,       // No adjustment
                'minor': 0.7,         // Significant reduction
                'moderate': 0.4,      // Major reduction
                'serious': 0.0        // Already handled above
            };

            // Calculate base dose (mg/kg for route and substance)
            let baseDose = weight * intensityDoses[intensity][substance][route];

            // Apply all multipliers
            baseDose *= experienceMultiplier[experience] * genderMultiplier[gender] * settingMultiplier[setting] * healthMultiplier[health];

            // Tolerance factor based on recent use - REDUCED to prevent dangerous escalation
            let toleranceFactor = 1.0;
            if (lastUse < 1) {
                toleranceFactor = 1.2; // High tolerance - REDUCED from 1.4
            } else if (lastUse < 3) {
                toleranceFactor = 1.1; // Moderate tolerance - REDUCED from 1.2
            } else if (lastUse < 7) {
                toleranceFactor = 1.05; // Mild tolerance - REDUCED from 1.1
            }

            baseDose *= toleranceFactor;

            // SAFETY CAP: Never recommend more than 2x base dose regardless of tolerance
            const originalBaseDose = weight * intensityDoses[intensity][substance][route];
            const maxToleranceDose = originalBaseDose * 2.0;
            if (baseDose > maxToleranceDose) {
                baseDose = maxToleranceDose;
                warnings += showWarning('Dose capped at 2x base due to safety concerns. Consider taking a longer break to reset tolerance.', 'danger');
            }

            // Safety caps by substance and route - REDUCED to safer levels
            const maxSafeDose = {
                'amphetamine': { oral: 35, nasal: 20, sublingual: 25, rectal: 25, intravenous: 12, smoked: 12 },
                'dextroamphetamine': { oral: 25, nasal: 15, sublingual: 20, rectal: 20, intravenous: 10, smoked: 10 },
                'methamphetamine': { oral: 18, nasal: 10, sublingual: 12, rectal: 12, intravenous: 6, smoked: 6 },
                'adderall': { oral: 30, nasal: 18, sublingual: 22, rectal: 22, intravenous: 10, smoked: 10 }
            };

            const safeDose = Math.min(baseDose, maxSafeDose[substance][route]);

            // Generate warnings based on multiple factors
            let warnings = '';
            let riskLevel = 'low';

            // Route-specific warnings
            if (['intravenous', 'smoked'].includes(route)) {
                warnings += showWarning('IV/Smoking routes carry extreme addiction risk and dangerous cardiovascular effects!', 'danger');
                riskLevel = 'extreme';
            } else if (route === 'nasal') {
                warnings += showWarning('Nasal use can damage nasal passages and increases addiction potential.');
                riskLevel = 'moderate';
            }

            // Substance-specific warnings
            if (substance === 'methamphetamine') {
                warnings += showWarning('Methamphetamine has very high neurotoxicity and addiction potential. Consider safer alternatives.', 'danger');
                riskLevel = 'high';
            }

            // Health-based warnings
            if (health === 'moderate') {
                warnings += showWarning('Cardiovascular issues present - monitor heart rate, blood pressure, and have medical support available.', 'danger');
                riskLevel = 'high';
            } else if (health === 'minor') {
                warnings += showWarning('Monitor cardiovascular signs closely. Stop immediately if chest pain, irregular heartbeat, or breathing difficulties occur.');
            }

            // Dose-based warnings
            if (safeDose > maxSafeDose[substance][route] * 0.8) {
                warnings += showWarning('High dose - serious cardiovascular risks! Monitor vital signs.', 'danger');
                riskLevel = 'high';
            } else if (safeDose > maxSafeDose[substance][route] * 0.6) {
                warnings += showWarning('Moderate-high dose - monitor heart rate and blood pressure.');
                riskLevel = 'moderate';
            }

            // Experience vs intensity warnings
            if (experience === 'beginner' && intensity === 'strong') {
                warnings += showWarning('Strong doses not recommended for beginners. High risk of panic, overstimulation, and cardiovascular issues.');
            }

            // Frequency warnings
            if (lastUse < 3) {
                warnings += showWarning('Recent use detected - tolerance develops quickly with stimulants. Risk of dependence and cardiovascular strain.');
            }

            // Timeline and duration info by route
            const routeInfo = {
                'oral': { onset: '30-60 minutes', peak: '2-4 hours', duration: getDuration(substance, 'oral'), bioavailability: '70-80%' },
                'nasal': { onset: '5-15 minutes', peak: '30-90 minutes', duration: getDuration(substance, 'nasal'), bioavailability: '60-70%' },
                'sublingual': { onset: '15-30 minutes', peak: '1-2 hours', duration: getDuration(substance, 'sublingual'), bioavailability: '50-60%' },
                'rectal': { onset: '10-30 minutes', peak: '1-3 hours', duration: getDuration(substance, 'rectal'), bioavailability: '80-90%' },
                'intravenous': { onset: 'Immediate', peak: '5-15 minutes', duration: getDuration(substance, 'iv'), bioavailability: '100%' },
                'smoked': { onset: 'Immediate', peak: '2-10 minutes', duration: getDuration(substance, 'smoked'), bioavailability: '70-90%' }
            };

            function getDuration(sub, rt) {
                const durations = {
                    'amphetamine': { oral: '4-6 hours', nasal: '2-4 hours', sublingual: '3-5 hours', rectal: '4-6 hours', iv: '1-3 hours', smoked: '1-3 hours' },
                    'dextroamphetamine': { oral: '4-6 hours', nasal: '2-4 hours', sublingual: '3-5 hours', rectal: '4-6 hours', iv: '1-3 hours', smoked: '1-3 hours' },
                    'methamphetamine': { oral: '8-12 hours', nasal: '4-8 hours', sublingual: '6-10 hours', rectal: '8-12 hours', iv: '4-8 hours', smoked: '4-8 hours' },
                    'adderall': { oral: '4-6 hours', nasal: '2-4 hours', sublingual: '3-5 hours', rectal: '4-6 hours', iv: '1-3 hours', smoked: '1-3 hours' }
                };
                return durations[sub][rt];
            }

            const currentRoute = routeInfo[route];

            // Risk color coding
            const riskColors = {
                'low': '#10b981',
                'moderate': '#f59e0b',
                'high': '#ef4444',
                'extreme': '#7c2d12'
            };

            resultValue.innerHTML = `<span style="color: ${riskColors[riskLevel]}">${Math.round(safeDose)}mg</span>`;
            
            resultDetails.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.75rem;">💊 Dosage Information</h4>
                        <p><strong>Substance:</strong> ${substance.charAt(0).toUpperCase() + substance.slice(1)}</p>
                        <p><strong>Dose:</strong> ${Math.round(safeDose)}mg</p>
                        <p><strong>Route:</strong> ${route.charAt(0).toUpperCase() + route.slice(1)}</p>
                        <p><strong>Bioavailability:</strong> ${currentRoute.bioavailability}</p>
                        <p><strong>Risk level:</strong> <span style="color: ${riskColors[riskLevel]}">${riskLevel.toUpperCase()}</span></p>
                    </div>
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.75rem;">⏱️ ${route.charAt(0).toUpperCase() + route.slice(1)} Timeline</h4>
                        <p><strong>Onset:</strong> ${currentRoute.onset}</p>
                        <p><strong>Peak effects:</strong> ${currentRoute.peak}</p>
                        <p><strong>Duration:</strong> ${currentRoute.duration}</p>
                        <p><strong>Intensity:</strong> ${intensity.charAt(0).toUpperCase() + intensity.slice(1)}</p>
                    </div>
                </div>
                
                <div style="background: var(--background-secondary); padding: 1.25rem; border-radius: var(--radius-md); margin: 1.5rem 0;">
                    <h4 style="color: var(--success-color); margin-bottom: 1rem;">🛡️ Safety Guidelines for ${setting.charAt(0).toUpperCase() + setting.slice(1)} Setting</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <strong>Before:</strong><br>
                            • Check blood pressure/heart rate<br>
                            • Eat a proper meal<br>
                            • Get adequate sleep<br>
                            • Have emergency contacts ready
                        </div>
                        <div>
                            <strong>During:</strong><br>
                            • Monitor cardiovascular signs<br>
                            • Stay hydrated (not excessive)<br>
                            • Take breaks if overheating<br>
                            • Avoid combining with other drugs
                        </div>
                        <div>
                            <strong>After:</strong><br>
                            • Eat nutritious food<br>
                            • Get sleep when effects wear off<br>
                            • Monitor mood for several days<br>
                            • Wait appropriate time before next use
                        </div>
                    </div>
                </div>
                
                <div class="scientific-note">
                    <strong>Enhanced Calculation Factors:</strong><br>
                    • Base dose (${route}): ${intensityDoses[intensity][substance][route]}mg/kg for ${intensity} intensity<br>
                    • Experience adjustment: ${(experienceMultiplier[experience] * 100).toFixed(0)}% of standard dose<br>
                    • Gender factor: ${(genderMultiplier[gender] * 100).toFixed(0)}% adjustment<br>
                    • Setting safety factor: ${(settingMultiplier[setting] * 100).toFixed(0)}% adjustment<br>
                    • Health safety factor: ${(healthMultiplier[health] * 100).toFixed(0)}% adjustment<br>
                    • Tolerance factor: ${(toleranceFactor * 100).toFixed(0)}% (${lastUse} days since last use)<br>
                    Based on dopamine/norepinephrine reuptake inhibition and cardiovascular effects.
                </div>
                
                ${warnings}
            `;
            resultDiv.style.display = 'block';
        }

        // Enhanced cocaine calculator with comprehensive safety factors
        function calculateCocaine() {
            const weight = parseFloat(document.getElementById('coc-weight').value);
            const gender = document.getElementById('coc-gender').value;
            const experience = document.getElementById('coc-experience').value;
            const route = document.getElementById('coc-route').value;
            const intensity = document.getElementById('coc-intensity').value;
            const lastUse = parseFloat(document.getElementById('coc-last-use').value) || 14;
            const setting = document.getElementById('coc-setting').value;
            const health = document.getElementById('coc-health').value;
            const alcohol = document.getElementById('coc-alcohol').value;
            const resultValue = document.getElementById('coc-result-value');
            const resultDetails = document.getElementById('coc-details');
            const resultDiv = document.getElementById('coc-result');

            if (!validateWeight(weight) || !gender || !experience || !route || !intensity || !setting || !health || !alcohol) {
                resultValue.innerHTML = 'Please fill in all fields with valid values.';
                resultDetails.innerHTML = '';
                resultDiv.style.display = 'block';
                return;
            }

            // CRITICAL: Check for serious cardiovascular issues
            if (health === 'serious') {
                resultValue.innerHTML = 'CONTRAINDICATED';
                resultDetails.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(139, 69, 19, 0.2) 0%, rgba(139, 69, 19, 0.1) 100%); border: 2px solid #8B4513; border-radius: var(--radius-lg); padding: 2rem; margin: 1rem 0; text-align: center;">
                        <h3 style="color: #8B4513; margin-bottom: 1rem; font-size: 1.5rem;">⚠️ EXTREME CARDIOVASCULAR RISK ⚠️</h3>
                        <p style="color: var(--text-primary); font-size: 1.1rem; font-weight: bold; margin-bottom: 1rem;">
                            Cocaine + Heart Conditions = POTENTIALLY FATAL
                        </p>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Cocaine causes severe cardiovascular effects including heart attacks, strokes, and arrhythmias. With existing heart conditions, this is extremely dangerous.
                        </p>
                        <p style="color: #8B4513; font-weight: bold;">
                            NO SAFE DOSE FOR SERIOUS CARDIOVASCULAR CONDITIONS
                        </p>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return;
            }

            // CRITICAL: Check for alcohol consumption (creates cocaethylene)
            if (alcohol !== 'none') {
                resultValue.innerHTML = 'HIGHLY DANGEROUS';
                resultDetails.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(139, 69, 19, 0.2) 0%, rgba(139, 69, 19, 0.1) 100%); border: 2px solid #8B4513; border-radius: var(--radius-lg); padding: 2rem; margin: 1rem 0; text-align: center;">
                        <h3 style="color: #8B4513; margin-bottom: 1rem; font-size: 1.5rem;">⚠️ TOXIC COMBINATION ⚠️</h3>
                        <p style="color: var(--text-primary); font-size: 1.1rem; font-weight: bold; margin-bottom: 1rem;">
                            Cocaine + Alcohol = Cocaethylene (Cardiotoxic)
                        </p>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            This combination creates cocaethylene, which is more toxic than either substance alone and significantly increases risk of sudden cardiac death.
                        </p>
                        <p style="color: #8B4513; font-weight: bold;">
                            Wait at least 12+ hours after alcohol before considering cocaine use
                        </p>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return;
            }

            // CORRECTED dosage calculation - FIXED DANGEROUS OVER-DOSING
            const intensityDoses = {
                'threshold': { nasal: 0.12, oral: 0.2, gums: 0.1, smoked: 0.06, intravenous: 0.04 },
                'light': { nasal: 0.25, oral: 0.4, gums: 0.2, smoked: 0.12, intravenous: 0.08 },
                'common': { nasal: 0.5, oral: 0.8, gums: 0.4, smoked: 0.25, intravenous: 0.15 },
                'strong': { nasal: 0.8, oral: 1.3, gums: 0.65, smoked: 0.4, intravenous: 0.25 }
            };

            const experienceMultiplier = {
                'beginner': 0.5,      // Very conservative for safety
                'experienced': 0.7,   // Still conservative
                'expert': 0.85        // Slightly less conservative
            };

            // Gender-based metabolism differences
            const genderMultiplier = {
                'male': 1.0,
                'female': 0.8,        // Generally lower dose needed
                'other': 0.85         // Conservative approach
            };

            // Setting-based safety adjustments
            const settingMultiplier = {
                'home': 1.0,          // Safest environment
                'party': 0.8,         // Social setting, moderate reduction
                'club': 0.7,          // High-stimulation environment
                'public': 0.6         // Highest risk environment
            };

            // Health-based safety reductions
            const healthMultiplier = {
                'healthy': 1.0,       // No adjustment
                'minor': 0.6,         // Significant reduction
                'moderate': 0.3,      // Major reduction
                'serious': 0.0        // Already handled above
            };

            // Calculate base dose (mg/kg for route)
            let baseDose = weight * intensityDoses[intensity][route];

            // Apply all safety multipliers
            baseDose *= experienceMultiplier[experience] * genderMultiplier[gender] * settingMultiplier[setting] * healthMultiplier[health];

            // Tolerance factor (cocaine tolerance is rapid but short-lived) - REDUCED for safety
            let toleranceFactor = 1.0;
            if (lastUse < 1) {
                toleranceFactor = 1.15; // Moderate tolerance - REDUCED from 1.3
            } else if (lastUse < 3) {
                toleranceFactor = 1.08; // Mild tolerance - REDUCED from 1.15
            } else if (lastUse < 7) {
                toleranceFactor = 1.03; // Very mild tolerance - REDUCED from 1.05
            }

            baseDose *= toleranceFactor;

            // SAFETY CAP: Never recommend more than 2x base dose regardless of tolerance
            const originalBaseDose = weight * intensityDoses[intensity][route];
            const maxToleranceDose = originalBaseDose * 2.0;
            if (baseDose > maxToleranceDose) {
                baseDose = maxToleranceDose;
                warnings += showWarning('Dose capped at 2x base due to safety concerns. Cocaine has severe cardiovascular risks.', 'danger');
            }

            // STRICT safety caps by route - REDUCED to safer levels
            const maxSafeDose = {
                'nasal': 50,         // Nasal maximum - REDUCED from 120
                'oral': 80,          // Oral maximum - REDUCED from 200
                'gums': 40,          // Gums maximum - REDUCED from 100
                'smoked': 25,        // Smoking maximum - REDUCED from 60
                'intravenous': 15    // IV maximum - REDUCED from 40
            };

            const safeDose = Math.min(baseDose, maxSafeDose[route]);

            // Generate comprehensive warnings
            let warnings = '';
            let riskLevel = 'high'; // Cocaine is always high risk

            // Route-specific warnings
            if (route === 'intravenous') {
                warnings += showWarning('IV cocaine use carries EXTREME risks: overdose, heart attack, stroke, infection, collapsed veins, and addiction!', 'danger');
                riskLevel = 'extreme';
            } else if (route === 'smoked') {
                warnings += showWarning('Smoking cocaine (crack) has very high addiction potential and severe lung/cardiovascular risks!', 'danger');
                riskLevel = 'extreme';
            } else if (route === 'nasal') {
                warnings += showWarning('Nasal use can cause severe nasal damage, deviated septum, and loss of smell. High addiction risk.');
            }

            // Dose-based warnings
            if (safeDose > maxSafeDose[route] * 0.8) {
                warnings += showWarning('VERY HIGH DOSE - Serious risk of heart attack, stroke, and seizures!', 'danger');
            } else if (safeDose > maxSafeDose[route] * 0.6) {
                warnings += showWarning('High dose - Significant cardiovascular and neurological risks!', 'danger');
            }

            // Experience-based warnings
            if (experience === 'beginner') {
                warnings += showWarning('First-time users are at highest risk for adverse reactions. Have medical support available.');
            }

            // Health-based warnings
            if (health === 'moderate') {
                warnings += showWarning('Cardiovascular concerns present - extremely high risk of complications. Consider avoiding use entirely.', 'danger');
            } else if (health === 'minor') {
                warnings += showWarning('Monitor cardiovascular signs extremely closely. Seek immediate medical help for chest pain or breathing issues.', 'danger');
            }

            // Frequency warnings
            if (lastUse < 7) {
                warnings += showWarning('Recent use detected - cocaine has high addiction potential and cardiovascular cumulative effects.');
            }

            // Universal cocaine warnings
            warnings += showWarning('Cocaine carries severe risks: heart attack, stroke, seizures, hyperthermia, and addiction. Consider harm reduction alternatives.', 'danger');
            warnings += showWarning('Never mix with alcohol, depressants, or other stimulants. Have emergency contacts ready.', 'danger');

            // Timeline and duration info by route
            const routeInfo = {
                'nasal': { onset: '1-5 minutes', peak: '15-30 minutes', duration: '20-60 minutes', bioavailability: '60-80%' },
                'oral': { onset: '30-60 minutes', peak: '60-90 minutes', duration: '60-120 minutes', bioavailability: '30-40%' },
                'gums': { onset: '5-15 minutes', peak: '15-45 minutes', duration: '30-90 minutes', bioavailability: '40-60%' },
                'smoked': { onset: 'Immediate', peak: '2-5 minutes', duration: '5-15 minutes', bioavailability: '70-90%' },
                'intravenous': { onset: 'Immediate', peak: '1-3 minutes', duration: '5-20 minutes', bioavailability: '100%' }
            };

            const currentRoute = routeInfo[route];

            // Risk color coding
            const riskColors = {
                'high': '#ef4444',
                'extreme': '#7c2d12'
            };

            resultValue.innerHTML = `<span style="color: ${riskColors[riskLevel]}">${Math.round(safeDose)}mg</span>`;
            
            resultDetails.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.75rem;">💊 Dosage Information</h4>
                        <p><strong>Dose:</strong> ${Math.round(safeDose)}mg</p>
                        <p><strong>Route:</strong> ${route.charAt(0).toUpperCase() + route.slice(1)}</p>
                        <p><strong>Bioavailability:</strong> ${currentRoute.bioavailability}</p>
                        <p><strong>Purity assumption:</strong> 70% (street cocaine)</p>
                        <p><strong>Risk level:</strong> <span style="color: ${riskColors[riskLevel]}">${riskLevel.toUpperCase()}</span></p>
                    </div>
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.75rem;">⏱️ ${route.charAt(0).toUpperCase() + route.slice(1)} Timeline</h4>
                        <p><strong>Onset:</strong> ${currentRoute.onset}</p>
                        <p><strong>Peak effects:</strong> ${currentRoute.peak}</p>
                        <p><strong>Duration:</strong> ${currentRoute.duration}</p>
                        <p><strong>Compulsive redosing:</strong> Very high risk</p>
                    </div>
                </div>
                
                <div style="background: var(--background-secondary); padding: 1.25rem; border-radius: var(--radius-md); margin: 1.5rem 0;">
                    <h4 style="color: #ef4444; margin-bottom: 1rem;">🚨 CRITICAL Safety Guidelines</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <strong>Before:</strong><br>
                            • Check blood pressure/heart rate<br>
                            • ZERO alcohol for 24+ hours<br>
                            • Have naloxone and emergency contacts<br>
                            • Remove dangerous objects
                        </div>
                        <div>
                            <strong>During:</strong><br>
                            • Monitor heart rate constantly<br>
                            • Stay cool and hydrated<br>
                            • Avoid combining with any other drugs<br>
                            • Set limits beforehand
                        </div>
                        <div>
                            <strong>Emergency:</strong><br>
                            • Call emergency services for chest pain<br>
                            • Be honest with medical staff<br>
                            • Watch for hyperthermia signs<br>
                            • Aspirin for heart attack symptoms
                        </div>
                    </div>
                </div>
                
                <div class="scientific-note">
                    <strong>Enhanced Calculation Factors:</strong><br>
                    • Base dose (${route}): ${intensityDoses[intensity][route]}mg/kg for ${intensity} intensity<br>
                    • Experience safety factor: ${(experienceMultiplier[experience] * 100).toFixed(0)}% of standard dose<br>
                    • Gender factor: ${(genderMultiplier[gender] * 100).toFixed(0)}% adjustment<br>
                    • Setting safety factor: ${(settingMultiplier[setting] * 100).toFixed(0)}% adjustment<br>
                    • Health safety factor: ${(healthMultiplier[health] * 100).toFixed(0)}% adjustment<br>
                    • Tolerance factor: ${(toleranceFactor * 100).toFixed(0)}% (${lastUse} days since last use)<br>
                    Cocaine blocks dopamine, norepinephrine, and sodium channels with severe cardiovascular effects.
                </div>
                
                ${warnings}
            `;
            resultDiv.style.display = 'block';
        }

        // Enhanced 4-MMC calculator with comprehensive safety factors
        function calculate4MMC() {
            const weight = parseFloat(document.getElementById('mmc-weight').value);
            const gender = document.getElementById('mmc-gender').value;
            const experience = document.getElementById('mmc-experience').value;
            const route = document.getElementById('mmc-route').value;
            const intensity = document.getElementById('mmc-intensity').value;
            const lastUse = parseFloat(document.getElementById('mmc-last-use').value) || 14;
            const setting = document.getElementById('mmc-setting').value;
            const cardiovascular = document.getElementById('mmc-cardiovascular').value;
            const temperature = document.getElementById('mmc-temperature').value;
            const serotonin = document.getElementById('mmc-serotonin').value;
            const resultValue = document.getElementById('mmc-result-value');
            const resultDetails = document.getElementById('mmc-details');
            const resultDiv = document.getElementById('mmc-result');

            if (!validateWeight(weight) || !gender || !experience || !route || !intensity || !setting || 
                !cardiovascular || !temperature || !serotonin) {
                resultValue.innerHTML = 'Please fill in all fields with valid values.';
                resultDetails.innerHTML = '';
                resultDiv.style.display = 'block';
                return;
            }

            // CRITICAL: Check for serious contraindications
            if (cardiovascular === 'serious') {
                resultValue.innerHTML = 'CONTRAINDICATED';
                resultDetails.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(139, 69, 19, 0.2) 0%, rgba(139, 69, 19, 0.1) 100%); border: 2px solid #8B4513; border-radius: var(--radius-lg); padding: 2rem; margin: 1rem 0; text-align: center;">
                        <h3 style="color: #8B4513; margin-bottom: 1rem; font-size: 1.5rem;">⚠️ EXTREME CARDIOVASCULAR RISK ⚠️</h3>
                        <p style="color: var(--text-primary); font-size: 1.1rem; font-weight: bold; margin-bottom: 1rem;">
                            4-MMC + Heart Conditions = POTENTIALLY FATAL
                        </p>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            4-MMC causes severe cardiovascular strain, hyperthermia, and arrhythmias. With existing heart conditions, this is extremely dangerous.
                        </p>
                        <p style="color: #8B4513; font-weight: bold;">
                            NO SAFE DOSE FOR SERIOUS CARDIOVASCULAR CONDITIONS
                        </p>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return;
            }

            // CRITICAL: Check for dangerous serotonin interactions
            if (serotonin === 'antidepressants') {
                resultValue.innerHTML = 'CONTRAINDICATED';
                resultDetails.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(139, 69, 19, 0.2) 0%, rgba(139, 69, 19, 0.1) 100%); border: 2px solid #8B4513; border-radius: var(--radius-lg); padding: 2rem; margin: 1rem 0; text-align: center;">
                        <h3 style="color: #8B4513; margin-bottom: 1rem; font-size: 1.5rem;">⚠️ SEROTONIN SYNDROME RISK ⚠️</h3>
                        <p style="color: var(--text-primary); font-size: 1.1rem; font-weight: bold; margin-bottom: 1rem;">
                            4-MMC + Antidepressants = SEROTONIN SYNDROME
                        </p>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            This combination can cause life-threatening serotonin syndrome with hyperthermia, seizures, and cardiovascular collapse.
                        </p>
                        <p style="color: #8B4513; font-weight: bold;">
                            NEVER COMBINE WITH SSRIs, SNRIs, OR MAOIs
                        </p>
                    </div>
                `;
                resultDiv.style.display = 'block';
                return;
            }

            // CORRECTED dosage calculation - FIXED DANGEROUS OVER-DOSING
            const intensityDoses = {
                'threshold': { oral: 0.5, nasal: 0.35, rectal: 0.4, intravenous: 0.2 },
                'light': { oral: 1.0, nasal: 0.7, rectal: 0.8, intravenous: 0.4 },
                'common': { oral: 1.6, nasal: 1.1, rectal: 1.3, intravenous: 0.7 },
                'strong': { oral: 2.4, nasal: 1.7, rectal: 2.0, intravenous: 1.0 }
            };

            const experienceMultiplier = {
                'beginner': 0.6,      // Very conservative for 4-MMC
                'experienced': 0.8,   // Still conservative due to neurotoxicity
                'expert': 0.9         // Slightly less conservative
            };

            // Gender-based metabolism differences
            const genderMultiplier = {
                'male': 1.0,
                'female': 0.85,       // Generally more sensitive
                'other': 0.9          // Conservative approach
            };

            // Setting-based safety adjustments (important for temperature regulation)
            const settingMultiplier = {
                'home': 1.0,          // Safest environment
                'party': 0.85,        // Social setting, some reduction
                'club': 0.7,          // High-stimulation, crowd heat
                'public': 0.6         // Highest risk environment
            };

            // Health-based safety reductions
            const healthMultiplier = {
                'healthy': 1.0,       // No adjustment
                'minor': 0.7,         // Significant reduction
                'moderate': 0.4,      // Major reduction
                'serious': 0.0        // Already handled above
            };

            // Temperature safety factor (crucial for 4-MMC)
            const temperatureMultiplier = {
                'cool': 1.0,          // Ideal conditions
                'warm': 0.8,          // Some risk reduction
                'hot': 0.6            // High hyperthermia risk
            };

            // Serotonin safety factor
            const serotoninMultiplier = {
                'none': 1.0,          // No recent use
                'mdma': 0.5,          // Significant serotonin depletion
                'recent': 0.6,        // Other recent serotonergic use
                'antidepressants': 0.0 // Already handled above
            };

            // Calculate base dose (mg/kg for route)
            let baseDose = weight * intensityDoses[intensity][route];

            // Apply all safety multipliers
            baseDose *= experienceMultiplier[experience] * genderMultiplier[gender] * 
                       settingMultiplier[setting] * healthMultiplier[cardiovascular] * 
                       temperatureMultiplier[temperature] * serotoninMultiplier[serotonin];

            // Tolerance factor (4-MMC has rapid tolerance development) - REDUCED for safety
            let toleranceFactor = 1.0;
            if (lastUse < 3) {
                toleranceFactor = 1.25; // Significant tolerance - REDUCED from 1.5
            } else if (lastUse < 7) {
                toleranceFactor = 1.15; // Moderate tolerance - REDUCED from 1.25
            } else if (lastUse < 14) {
                toleranceFactor = 1.05; // Mild tolerance - REDUCED from 1.1
            }

            baseDose *= toleranceFactor;

            // SAFETY CAP: Never recommend more than 2x base dose regardless of tolerance
            const originalBaseDose = weight * intensityDoses[intensity][route];
            const maxToleranceDose = originalBaseDose * 2.0;
            if (baseDose > maxToleranceDose) {
                baseDose = maxToleranceDose;
                warnings += showWarning('Dose capped at 2x base due to neurotoxicity concerns. 4-MMC is extremely dangerous with frequent use.', 'danger');
            }

            // STRICT safety caps by route - REDUCED to safer levels
            const maxSafeDose = {
                'oral': 100,          // Oral maximum - REDUCED from 200
                'nasal': 75,          // Nasal maximum - REDUCED from 150
                'rectal': 90,         // Rectal maximum - REDUCED from 180
                'intravenous': 40     // IV maximum - REDUCED from 80
            };

            const safeDose = Math.min(baseDose, maxSafeDose[route]);

            // Generate comprehensive warnings
            let warnings = '';
            let riskLevel = 'extreme'; // 4-MMC is always extremely high risk

            // Route-specific warnings
            if (route === 'intravenous') {
                warnings += showWarning('IV 4-MMC carries EXTREME risks: instant overdose, severe addiction, collapsed veins, and cardiac arrest!', 'danger');
            } else if (route === 'nasal') {
                warnings += showWarning('Nasal 4-MMC causes severe nasal damage and has high redose compulsion. Extreme addiction risk!', 'danger');
            }

            // Dose-based warnings
            if (safeDose > maxSafeDose[route] * 0.8) {
                warnings += showWarning('VERY HIGH DOSE - Severe hyperthermia, cardiovascular collapse, and neurotoxicity risk!', 'danger');
            } else if (safeDose > maxSafeDose[route] * 0.6) {
                warnings += showWarning('High dose - Significant hyperthermia and cardiovascular risks!', 'danger');
            }

            // Experience-based warnings
            if (experience === 'beginner') {
                warnings += showWarning('4-MMC is NOT suitable for beginners. Extremely high addiction and neurotoxicity risks.', 'danger');
            }

            // Health-based warnings
            if (cardiovascular === 'moderate') {
                warnings += showWarning('Cardiovascular concerns + 4-MMC = extremely high risk of heart attack or stroke!', 'danger');
            } else if (cardiovascular === 'minor') {
                warnings += showWarning('Monitor cardiovascular signs extremely closely. 4-MMC causes severe cardiac strain.', 'danger');
            }

            // Temperature warnings
            if (temperature === 'hot') {
                warnings += showWarning('HOT environment + 4-MMC = extreme hyperthermia risk. Consider avoiding use entirely.', 'danger');
            } else if (temperature === 'warm') {
                warnings += showWarning('Monitor body temperature constantly. 4-MMC causes dangerous hyperthermia.', 'danger');
            }

            // Serotonin warnings
            if (serotonin === 'mdma') {
                warnings += showWarning('Recent MDMA use detected - serotonin depletion increases neurotoxicity risk significantly!', 'danger');
            } else if (serotonin === 'recent') {
                warnings += showWarning('Recent serotonergic drug use increases risk of adverse reactions and neurotoxicity.', 'danger');
            }

            // Frequency warnings
            if (lastUse < 14) {
                warnings += showWarning('Frequent 4-MMC use causes severe neurotoxicity and rapid addiction development!', 'danger');
            }

            // Universal 4-MMC warnings
            warnings += showWarning('4-MMC is extremely neurotoxic and highly addictive. Maximum 2-3 uses per year recommended.', 'danger');
            warnings += showWarning('Compulsive redosing is common - remove access to additional material beforehand.', 'danger');
            warnings += showWarning('Monitor temperature constantly - hyperthermia can be fatal. Stay cool and hydrated.', 'danger');

            // Timeline and duration info by route
            const routeInfo = {
                'oral': { onset: '30-60 minutes', peak: '1-2 hours', duration: '4-6 hours', bioavailability: '70-90%' },
                'nasal': { onset: '5-15 minutes', peak: '30-60 minutes', duration: '2-4 hours', bioavailability: '80-95%' },
                'rectal': { onset: '15-30 minutes', peak: '45-90 minutes', duration: '3-5 hours', bioavailability: '85-95%' },
                'intravenous': { onset: 'Immediate', peak: '5-15 minutes', duration: '1-3 hours', bioavailability: '100%' }
            };

            const currentRoute = routeInfo[route];

            resultValue.innerHTML = `<span style="color: #7c2d12">${Math.round(safeDose)}mg</span>`;
            
            resultDetails.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.75rem;">💊 Dosage Information</h4>
                        <p><strong>Dose:</strong> ${Math.round(safeDose)}mg</p>
                        <p><strong>Route:</strong> ${route.charAt(0).toUpperCase() + route.slice(1)}</p>
                        <p><strong>Bioavailability:</strong> ${currentRoute.bioavailability}</p>
                        <p><strong>Purity assumption:</strong> 80% (laboratory grade)</p>
                        <p><strong>Risk level:</strong> <span style="color: #7c2d12">EXTREME</span></p>
                    </div>
                    <div>
                        <h4 style="color: var(--text-primary); margin-bottom: 0.75rem;">⏱️ ${route.charAt(0).toUpperCase() + route.slice(1)} Timeline</h4>
                        <p><strong>Onset:</strong> ${currentRoute.onset}</p>
                        <p><strong>Peak effects:</strong> ${currentRoute.peak}</p>
                        <p><strong>Duration:</strong> ${currentRoute.duration}</p>
                        <p><strong>Compulsive redosing:</strong> Very high risk</p>
                    </div>
                </div>
                
                <div style="background: var(--background-secondary); padding: 1.25rem; border-radius: var(--radius-md); margin: 1.5rem 0;">
                    <h4 style="color: #ef4444; margin-bottom: 1rem;">🚨 CRITICAL Safety Guidelines</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <strong>Before:</strong><br>
                            • Test for purity/adulterants<br>
                            • Remove all additional material<br>
                            • Ensure cool environment<br>
                            • Have emergency contacts ready
                        </div>
                        <div>
                            <strong>During:</strong><br>
                            • Monitor temperature constantly<br>
                            • Stay cool and hydrated<br>
                            • Avoid alcohol and stimulants<br>
                            • Resist redosing urges
                        </div>
                        <div>
                            <strong>After:</strong><br>
                            • 5-HTP supplementation (24h+ later)<br>
                            • Antioxidants (Vitamin C, E)<br>
                            • Wait minimum 3+ months<br>
                            • Monitor mental health
                        </div>
                    </div>
                </div>
                
                <div class="scientific-note">
                    <strong>Enhanced Calculation Factors:</strong><br>
                    • Base dose (${route}): ${intensityDoses[intensity][route]}mg/kg for ${intensity} intensity<br>
                    • Experience safety factor: ${(experienceMultiplier[experience] * 100).toFixed(0)}% of standard dose<br>
                    • Gender factor: ${(genderMultiplier[gender] * 100).toFixed(0)}% adjustment<br>
                    • Setting safety factor: ${(settingMultiplier[setting] * 100).toFixed(0)}% adjustment<br>
                    • Health safety factor: ${(healthMultiplier[cardiovascular] * 100).toFixed(0)}% adjustment<br>
                    • Temperature safety factor: ${(temperatureMultiplier[temperature] * 100).toFixed(0)}% adjustment<br>
                    • Serotonin safety factor: ${(serotoninMultiplier[serotonin] * 100).toFixed(0)}% adjustment<br>
                    • Tolerance factor: ${(toleranceFactor * 100).toFixed(0)}% (${lastUse} days since last use)<br>
                    4-MMC is a potent serotonin-norepinephrine-dopamine reuptake inhibitor with severe neurotoxic potential.
                </div>
                
                ${warnings}
            `;
            resultDiv.style.display = 'block';
        }

        // General tolerance calculator
        function calculateGeneralTolerance() {
            const substance = document.getElementById('tol-substance').value;
            const customHalflife = parseFloat(document.getElementById('tol-custom-halflife').value);
            const previousDose = parseFloat(document.getElementById('tol-previous-dose').value);
            const doseUnit = document.getElementById('tol-dose-unit').value;
            const daysAgo = parseFloat(document.getElementById('tol-days-ago').value);
            const targetEffect = document.getElementById('tol-target-effect').value;
            const effectMultiplier = parseFloat(document.getElementById('tol-effect-multiplier').value) || 1;
            const resultValue = document.getElementById('tolerance-result-value');
            const resultDetails = document.getElementById('tolerance-details');
            const resultDiv = document.getElementById('tolerance-result');

            // Validation
            if (!substance || isNaN(previousDose) || isNaN(daysAgo) || previousDose <= 0 || daysAgo < 0) {
                resultValue.innerHTML = 'Please fill in all required fields with valid values.';
                resultDetails.innerHTML = '';
                resultDiv.style.display = 'block';
                return;
            }

            if (substance === 'custom' && (isNaN(customHalflife) || customHalflife <= 0)) {
                resultValue.innerHTML = 'Please enter a valid custom tolerance half-life.';
                resultDetails.innerHTML = '';
                resultDiv.style.display = 'block';
                return;
            }

            // Tolerance half-lives in days (approximate values based on research)
            const toleranceHalfLives = {
                // Psychedelics - very fast tolerance, cross-tolerance between them
                'lsd': 2.5,               // LSD - classic psychedelic tolerance
                'psilocybin': 3,          // Psilocybin - slightly longer than LSD
                'dmt': 0.5,               // DMT - minimal tolerance buildup
                '2cb': 4,                 // 2C-B - phenethylamine tolerance
                'mescaline': 5,           // Mescaline - longer lasting tolerance
                
                // Entactogens - serotonin-heavy, longer recovery needed
                'mdma': 14,               // MDMA - long recovery due to serotonin depletion
                'mda': 12,                // MDA - similar to MDMA but slightly faster
                '4mmc': 10,               // 4-MMC - cathinone tolerance pattern
                '6apb': 16,               // 6-APB - longer acting, longer tolerance
                
                // Stimulants - dopamine/norepinephrine, moderate tolerance
                'amphetamine': 7,         // Amphetamine - moderate stimulant tolerance
                'dextroamphetamine': 6,   // Dextroamphetamine - slightly faster recovery
                'methamphetamine': 10,    // Methamphetamine - longer tolerance due to neurotoxicity
                'cocaine': 2,             // Cocaine - fast tolerance but quick recovery
                'caffeine': 1,            // Caffeine - daily tolerance cycle
                'modafinil': 3,           // Modafinil - unique mechanism, moderate tolerance
                
                // Dissociatives - NMDA antagonism, variable tolerance
                'ketamine': 4,            // Ketamine - moderate NMDA tolerance
                'dxm': 7,                 // DXM - longer tolerance due to multiple mechanisms
                'pcp': 14,                // PCP - long-lasting tolerance
                '3meopcp': 10,            // 3-MeO-PCP - research chemical, estimated
                
                // Depressants - GABA system, fast tolerance development
                'ghb': 3,                 // GHB - fast tolerance, dangerous escalation
                'gbl': 3,                 // GBL - similar to GHB
                'phenibut': 3,            // Phenibut - rapid tolerance development
                'alcohol': 1,             // Alcohol - daily tolerance cycle
                'xanax': 7,               // Alprazolam - benzodiazepine tolerance
                'valium': 14,             // Diazepam - longer half-life, longer tolerance
                
                // Opioids - significant tolerance and dependence issues
                'morphine': 5,            // Morphine - classic opioid tolerance
                'oxycodone': 4,           // Oxycodone - faster tolerance development
                'tramadol': 6,            // Tramadol - unique mechanism, moderate tolerance
                'kratom': 3,              // Kratom - faster tolerance than traditional opioids
                
                // Cannabis - cannabinoid system
                'thc': 3,                 // THC - fast tolerance development
                'cbd': 0.5,               // CBD - minimal tolerance
                
                // Other
                'nitrous': 0.1,           // N2O - virtually no tolerance
                'custom': customHalflife  // User-defined
            };

            const toleranceHalfLife = toleranceHalfLives[substance];

            // Calculate remaining tolerance (exponential decay)
            const toleranceDecay = Math.pow(0.5, daysAgo / toleranceHalfLife);
            const remainingTolerance = toleranceDecay;

            // Generate tolerance recovery graph
            generateToleranceGraph(toleranceHalfLife, daysAgo, substance);

            // Calculate required dose multiplier based on target effect
            let targetMultiplier = 1;
            switch (targetEffect) {
                case 'same':
                    targetMultiplier = 1;
                    break;
                case 'stronger':
                    targetMultiplier = effectMultiplier;
                    break;
                case 'weaker':
                    targetMultiplier = effectMultiplier;
                    break;
                case 'baseline':
                    targetMultiplier = 1;
                    // For baseline, we calculate what the original dose would be without any tolerance
                    const baselineDose = previousDose / (1 + remainingTolerance);
                    resultValue.innerHTML = `${baselineDose.toFixed(2)} ${doseUnit}`;
                    resultDetails.innerHTML = `
                        <p><strong>Baseline dose (no tolerance):</strong> ${baselineDose.toFixed(2)} ${doseUnit}</p>
                        <p><strong>Your previous dose had tolerance:</strong> ${(remainingTolerance * 100).toFixed(1)}% tolerance present</p>
                        <p><strong>Current tolerance remaining:</strong> ${(toleranceDecay * 100).toFixed(1)}%</p>
                        <div class="scientific-note">
                            <strong>Substance:</strong> ${substance.charAt(0).toUpperCase() + substance.slice(1)}<br>
                            <strong>Tolerance half-life:</strong> ${toleranceHalfLife} days<br>
                            <strong>Recovery rate:</strong> ${((1 - toleranceDecay) * 100).toFixed(1)}% recovered
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                    return;
            }

            // Calculate required dose for target effect
            // If we want the same effect as before, we need to account for current tolerance
            let requiredDose = previousDose * targetMultiplier;

            // Adjust for current tolerance level
            if (remainingTolerance > 0) {
                requiredDose = requiredDose * (1 + remainingTolerance);
            }

            // Safety warnings
            let warnings = '';
            const doseIncrease = requiredDose / previousDose;
            
            if (doseIncrease > 2.0) {
                warnings += showWarning('Very high dose increase required - consider waiting longer for tolerance to decrease!', 'danger');
            } else if (doseIncrease > 1.5) {
                warnings += showWarning('Significant dose increase required - exercise caution and consider harm reduction strategies.');
            }

            if (daysAgo < toleranceHalfLife) {
                warnings += showWarning(`Short time since last dose. Consider waiting longer for better tolerance recovery (half-life: ${toleranceHalfLife} days).`);
            }

            // Substance-specific warnings
            // Psychedelics
            if (['lsd', 'psilocybin', '2cb', 'mescaline'].includes(substance) && daysAgo < 7) {
                warnings += showWarning('Psychedelics: Consider waiting at least 1-2 weeks between uses for full tolerance reset and meaningful experiences.');
            } else if (substance === 'dmt' && daysAgo < 1) {
                warnings += showWarning('DMT: While tolerance is minimal, consider spacing sessions for integration time.');
            
            // Entactogens - Serotonin heavy substances
            } else if (substance === 'mdma' && daysAgo < 30) {
                warnings += showWarning('MDMA: Recommended to wait at least 1-3 months between uses for serotonin recovery and safety.', 'danger');
            } else if (substance === 'mda' && daysAgo < 30) {
                warnings += showWarning('MDA: Similar to MDMA - wait at least 1-3 months between uses for neurotransmitter recovery.', 'danger');
            } else if (substance === '4mmc' && daysAgo < 14) {
                warnings += showWarning('4-MMC: Recommended to wait at least 2 weeks between uses due to neurotoxicity concerns.', 'danger');
            } else if (substance === '6apb' && daysAgo < 45) {
                warnings += showWarning('6-APB: Very long-acting - wait at least 6-8 weeks between uses for safety.', 'danger');
            
            // Stimulants
            } else if (substance === 'methamphetamine') {
                warnings += showWarning('Methamphetamine: High neurotoxicity and addiction potential. Consider harm reduction resources.', 'danger');
            } else if (substance === 'cocaine' && daysAgo < 3) {
                warnings += showWarning('Cocaine: High cardiovascular risks and addiction potential. Frequent use is dangerous.');
            } else if (substance === 'caffeine' && daysAgo < 2) {
                warnings += showWarning('Caffeine: Daily tolerance develops quickly. Consider cycling to maintain effectiveness.');
            
            // Dissociatives
            } else if (substance === 'ketamine' && daysAgo < 7) {
                warnings += showWarning('Ketamine: Frequent use can lead to bladder damage and psychological dependence.');
            } else if (substance === 'pcp') {
                warnings += showWarning('PCP: Extremely unpredictable and dangerous substance. High risk of injury and legal issues.', 'danger');
            
            // Depressants
            } else if (['ghb', 'gbl'].includes(substance)) {
                warnings += showWarning('GHB/GBL: Extremely dangerous - narrow margin between active and lethal dose. Never mix with alcohol!', 'danger');
            } else if (substance === 'alcohol' && daysAgo < 1) {
                warnings += showWarning('Alcohol: Daily use leads to rapid tolerance and health issues. Consider moderation.');
            } else if (['xanax', 'valium'].includes(substance)) {
                warnings += showWarning('Benzodiazepines: High dependence potential and dangerous withdrawals. Medical supervision recommended.', 'danger');
            } else if (substance === 'phenibut' && daysAgo < 3) {
                warnings += showWarning('Phenibut: Rapid tolerance and severe withdrawal syndrome. Maximum 2-3 times per week.', 'danger');
            
            // Opioids
            } else if (['morphine', 'oxycodone', 'tramadol', 'kratom'].includes(substance)) {
                warnings += showWarning('Opioids: Extremely high addiction potential and serious tolerance issues. Consider harm reduction resources.', 'danger');
            
            // Cannabis
            } else if (substance === 'thc' && daysAgo < 2) {
                warnings += showWarning('THC: Rapid tolerance development with daily use. Consider tolerance breaks for effectiveness.');
            
            // Special cases
            } else if (substance === 'nitrous' && daysAgo < 0.1) {
                warnings += showWarning('Nitrous Oxide: Risk of B12 depletion with frequent use. Ensure adequate spacing and B12 supplementation.');
            }

            resultValue.innerHTML = `${requiredDose.toFixed(2)} ${doseUnit}`;
            resultDetails.innerHTML = `
                <p><strong>Previous dose:</strong> ${previousDose} ${doseUnit}</p>
                <p><strong>Required dose:</strong> ${requiredDose.toFixed(2)} ${doseUnit}</p>
                <p><strong>Dose multiplier:</strong> ${doseIncrease.toFixed(2)}x</p>
                <p><strong>Current tolerance:</strong> ${(toleranceDecay * 100).toFixed(1)}% remaining</p>
                <p><strong>Recovery:</strong> ${((1 - toleranceDecay) * 100).toFixed(1)}% recovered</p>
                <div class="scientific-note">
                    <strong>Substance category:</strong> ${substance.charAt(0).toUpperCase() + substance.slice(1)}<br>
                    <strong>Tolerance half-life:</strong> ${toleranceHalfLife} days<br>
                    <strong>Days since last use:</strong> ${daysAgo} days<br>
                    <strong>Target effect:</strong> ${targetEffect === 'same' ? 'Same as previous' : targetEffect}
                    ${targetEffect !== 'same' ? `<br><strong>Effect multiplier:</strong> ${effectMultiplier}x` : ''}
                </div>
                ${warnings}
            `;
            resultDiv.style.display = 'block';
        }

        // Generate tolerance recovery graph
        function generateToleranceGraph(halfLife, currentDay, substance) {
            const canvas = document.getElementById('tolerance-graph');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = 600;
            canvas.height = 300;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Graph dimensions
            const padding = 50;
            const graphWidth = canvas.width - 2 * padding;
            const graphHeight = canvas.height - 2 * padding;
            
            // Time range (show up to 4 half-lives for good visualization)
            const maxDays = Math.max(halfLife * 4, currentDay + halfLife);
            const timeStep = maxDays / 100; // 100 points for smooth curve
            
            // Set up drawing context
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            // Y-axis
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            // X-axis
            ctx.moveTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // Draw tolerance curve
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            let firstPoint = true;
            for (let day = 0; day <= maxDays; day += timeStep) {
                const tolerance = Math.pow(0.5, day / halfLife) * 100; // Convert to percentage
                const x = padding + (day / maxDays) * graphWidth;
                const y = canvas.height - padding - (tolerance / 100) * graphHeight;
                
                if (firstPoint) {
                    ctx.moveTo(x, y);
                    firstPoint = false;
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // Mark current day
            if (currentDay <= maxDays) {
                const currentTolerance = Math.pow(0.5, currentDay / halfLife) * 100;
                const currentX = padding + (currentDay / maxDays) * graphWidth;
                const currentY = canvas.height - padding - (currentTolerance / 100) * graphHeight;
                
                // Draw current day marker
                ctx.fillStyle = '#ff6b6b';
                ctx.beginPath();
                ctx.arc(currentX, currentY, 6, 0, 2 * Math.PI);
                ctx.fill();
                
                // Draw vertical line to current day
                ctx.strokeStyle = '#ff6b6b';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(currentX, currentY);
                ctx.lineTo(currentX, canvas.height - padding);
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // Add labels
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px Segoe UI';
            ctx.textAlign = 'center';
            
            // Y-axis labels (tolerance percentage)
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            for (let i = 0; i <= 100; i += 25) {
                const y = canvas.height - padding - (i / 100) * graphHeight;
                ctx.fillText(i + '%', padding - 10, y);
                
                // Draw grid lines
                if (i > 0) {
                    ctx.strokeStyle = '#e0e0e0';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(canvas.width - padding, y);
                    ctx.stroke();
                }
            }
            
            // X-axis labels (days)
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            const dayStep = Math.ceil(maxDays / 8); // Show about 8 labels
            for (let day = 0; day <= maxDays; day += dayStep) {
                const x = padding + (day / maxDays) * graphWidth;
                ctx.fillStyle = '#333';
                ctx.fillText(Math.round(day) + 'd', x, canvas.height - padding + 5);
                
                // Draw grid lines
                if (day > 0) {
                    ctx.strokeStyle = '#e0e0e0';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(x, padding);
                    ctx.lineTo(x, canvas.height - padding);
                    ctx.stroke();
                }
            }
            
            // Add axis titles
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Segoe UI';
            
            // Y-axis title
            ctx.save();
            ctx.translate(20, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.fillText('Tolerance Level (%)', 0, 0);
            ctx.restore();
            
            // X-axis title
            ctx.textAlign = 'center';
            ctx.fillText('Days Since Last Use', canvas.width / 2, canvas.height - 10);
            
            // Add half-life marker
            if (halfLife <= maxDays) {
                const halfLifeX = padding + (halfLife / maxDays) * graphWidth;
                ctx.strokeStyle = '#ffa500';
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 5]);
                ctx.beginPath();
                ctx.moveTo(halfLifeX, padding);
                ctx.lineTo(halfLifeX, canvas.height - padding);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Half-life label
                ctx.fillStyle = '#ffa500';
                ctx.font = 'bold 12px Segoe UI';
                ctx.textAlign = 'center';
                ctx.fillText('Half-life', halfLifeX, padding - 10);
            }
            
            // Add substance name and half-life info
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px Segoe UI';
            ctx.textAlign = 'left';
            const substanceName = substance.charAt(0).toUpperCase() + substance.slice(1);
            ctx.fillText(`${substanceName} (t½ = ${halfLife}d)`, padding + 10, padding + 20);
        }

        // Show/hide custom half-life input based on substance selection
        function handleSubstanceChange() {
            const substance = document.getElementById('tol-substance').value;
            const customGroup = document.getElementById('custom-halflife-group');
            
            if (substance === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
            }
        }

        // Show/hide effect multiplier based on target effect
        function handleTargetEffectChange() {
            const targetEffect = document.getElementById('tol-target-effect').value;
            const multiplierGroup = document.getElementById('effect-multiplier-group');
            
            if (targetEffect === 'stronger' || targetEffect === 'weaker') {
                multiplierGroup.style.display = 'block';
            } else {
                multiplierGroup.style.display = 'none';
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Show liquid calculator by default
            showCalculator('liquid');
            
            // Add event listeners for dynamic form behavior
            const substanceSelect = document.getElementById('tol-substance');
            const targetEffectSelect = document.getElementById('tol-target-effect');
            
            if (substanceSelect) {
                substanceSelect.addEventListener('change', handleSubstanceChange);
            }
            
            if (targetEffectSelect) {
                targetEffectSelect.addEventListener('change', handleTargetEffectChange);
            }
        });
    </script>
</body>
</html>
